{% extends 'base.html' %}

{% block title %}Pedidos - Sistema Cantina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/pedidos-ativos.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="caixa-container">
    <!-- √ÅREA PRINCIPAL -->
    <div class="caixa-main">
        <!-- ABA: NOVO PEDIDO -->
        <div id="tab-novo-pedido" class="tab-content {% if aba_ativa == 'novo-pedido' %}active{% endif %}">
            <div class="novo-pedido-layout">
                <!-- COLUNA ESQUERDA: CARD√ÅPIO -->
                <div class="cardapio-section">
                    <div class="cardapio-header">
                        <h3>üçΩÔ∏è Card√°pio</h3>
                        <span class="items-count">{{ produtos.count }} itens</span>
                    </div>

                    <div class="busca-produto" style="display: flex; gap: 0.8rem; align-items: center;">
                        <input type="text" id="busca-item" class="form-control" placeholder="üîç Buscar item por nome ou c√≥digo..." autocomplete="off" oninput="filtrarCardapio()" style="flex: 1;">
                        <select id="filtro-categoria-cardapio" class="form-control" onchange="filtrarCardapio()" style="width: 200px;">
                            <option value="">Todas as Categorias</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.nome }}">{{ categoria.emoji }} {{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="produtos-cardapio-grid">
                        {% for produto in produtos %}
                        <div class="produto-card-cardapio" 
                             data-nome="{{ produto.nome|lower }}" 
                             data-codigo="{{ produto.id }}"
                             data-categoria="{% if produto.categoria %}{{ produto.categoria.nome }}{% endif %}"
                             data-is-combo="{% if produto.is_combo %}true{% else %}false{% endif %}"
                             onclick="{% if produto.is_combo %}abrirModalSelecaoCombo({{ produto.get_combo_id }}, '{{ produto.nome|escapejs }}', {{ produto.preco }}){% else %}adicionarProduto({{ produto.id }}, '{{ produto.nome }}', {{ produto.preco }}){% endif %}">
                            <div class="produto-card-info">
                                <h4>{% if produto.is_combo %}üéÅ {% endif %}{{ produto.nome }}</h4>
                                <span class="produto-codigo">#{{ produto.id|stringformat:"03d" }}</span>
                            </div>
                            <div class="produto-card-preco">R$ {{ produto.preco }}</div>
                            {% if produto.quantidade_estoque > 0 and not produto.is_combo %}
                            <span class="produto-badge-estoque" data-produto-id="{{ produto.id }}" style="display: none;">{{ produto.quantidade_estoque }} un</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- COLUNA DIREITA: FORMUL√ÅRIO DO PEDIDO -->
                <div class="pedido-form-section">
                    <div class="form-header">
                        <h3>üõí Novo Pedido</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üë§ Nome do Cliente</label>
                        <input type="text" id="cliente-nome" class="form-control" placeholder="Digite o nome do cliente..." autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">üìç Refei√ß√£o</label>
                            <select id="tipo-pedido" class="form-control">
                                <option value="balcao">‚õ™ Local</option>
                                <option value="delivery">üöó Viagem</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üí≥ Pagamento</label>
                            <select id="forma-pagamento" class="form-control">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">üíµ Dinheiro</option>
                                <option value="debito">üí≥ D√©bito</option>
                                <option value="credito">üí≥ Cr√©dito</option>
                                <option value="pix">üì± PIX</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìù Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-control" rows="1" placeholder="Observa√ß√µes especiais do pedido..."></textarea>
                    </div>

                    <div class="itens-section">
                        <div class="itens-header">
                            <span>üõçÔ∏è Itens (<span id="itens-count">0</span>)</span>
                        </div>
                        
                        <div id="lista-itens" class="lista-itens-pedido">
                            <div class="carrinho-vazio">
                                <div class="carrinho-vazio-icon">üõí</div>
                                <p>Carrinho vazio</p>
                                <small>Clique nos itens do card√°pio para adicionar</small>
                            </div>
                        </div>
                    </div>

                    <div class="total-pedido-section">
                        <div class="total-label">üí∞ Total:</div>
                        <div class="total-valor">R$ <span id="total-pedido">0.00</span></div>
                    </div>

                    <button onclick="finalizarPedido()" class="btn-finalizar-pedido-full">
                        Finalizar Pedido
                    </button>
                </div>
            </div>
        </div>

        <!-- ABA: CARD√ÅPIO DO DIA -->
        <div id="tab-cardapio" class="tab-content {% if aba_ativa == 'cardapio' %}active{% endif %}">
            <h2 class="page-title">üìã Card√°pio do Dia</h2>
            
            <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center;">
                <input type="text" id="busca-cardapio-caixa" class="form-control" placeholder="üîç Buscar produto..." style="max-width: 400px;" autocomplete="off">
                <span id="contador-disponiveis" style="color: var(--text-secondary); font-size: 0.9rem; margin-left: auto;">
                    <span style="color: var(--btn-primary); font-weight: 600;" id="total-disponiveis">0</span> itens dispon√≠veis
                </span>
                <button class="btn-action" onclick="limparSelecaoCardapio()">üóëÔ∏è Limpar Sele√ß√£o</button>
            </div>
            
            <div class="table-wrapper-fixed-header">
                <table class="data-table data-table-header">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Pre√ßo</th>
                            <th>Dispon√≠vel Hoje</th>
                            <th>Mostrar Estoque</th>
                        </tr>
                    </thead>
                </table>
                
                <div class="table-scroll-container">
                    <table class="data-table" id="tabela-cardapio">
                        <tbody>
                            {% for produto in todos_produtos %}
                            <tr data-produto-nome="{{ produto.nome|lower }}" data-produto-id="{{ produto.id }}">
                                <td><strong>{{ produto.nome }}</strong></td>
                                <td>R$ {{ produto.preco }}</td>
                                <td>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-produto-id="{{ produto.id }}" {% if produto.ativo %}checked{% endif %} onchange="atualizarDisponibilidade(this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                                <td>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-produto-id="{{ produto.id }}" onchange="toggleMostrarEstoque(this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA: ESTOQUE -->
        <div id="tab-estoque" class="tab-content {% if aba_ativa == 'estoque' %}active{% endif %}">
            <h2 class="page-title">üì¶ Gest√£o de Estoque</h2>
            
            <!-- Linha √∫nica com todos os controles -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                <button class="btn-action" onclick="abrirModalProduto()">+ Novo Item</button>
                <button class="btn-action" onclick="abrirModalCombo()" style="background: linear-gradient(135deg, #F4A23A 0%, #FF8C00 100%);">üéÅ Novo Combo</button>
                <button class="btn-action" onclick="abrirModalCategorias()">üìÇ Categorias</button>
                
                <div style="flex: 1;">
                    <input 
                        type="text" 
                        id="pesquisa-estoque" 
                        class="form-control" 
                        placeholder="üîç Pesquisar item..."
                        onkeyup="filtrarEstoque()"
                        style="margin: 0;">
                </div>
                
                <div style="width: 220px;">
                    <select 
                        id="filtro-categoria-estoque" 
                        class="form-control" 
                        onchange="filtrarEstoque()"
                        style="margin: 0;">
                        <option value="">üìÇ Todas as Categorias</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.nome }}">{{ categoria.emoji }} {{ categoria.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button class="btn-action" onclick="limparFiltrosEstoque()">üîÑ Limpar</button>
            </div>
            
            <div class="table-wrapper-fixed-header" style="margin-top: 1rem;">
                <!-- Tabela de Estoque com Bot√£o de Edi√ß√£o -->
                <!-- DEBUG: Total de produtos = {{ todos_produtos.count }} -->
                <table class="data-table data-table-header">
                    <thead>
                        <tr>
                            <th style="width: 10%;">C√≥digo</th>
                            <th style="width: 25%;">Nome</th>
                            <th style="width: 20%;">Categoria</th>
                            <th style="width: 15%;">Quantidade</th>
                            <th style="width: 15%;">Pre√ßo (R$)</th>
                            <th style="width: 15%;">A√ß√µes</th>
                        </tr>
                    </thead>
                </table>
                
                <div class="table-scroll-container">
                    <table class="data-table" id="tabela-estoque">
                        <tbody>
                            {% for produto in todos_produtos %}
                            <tr data-nome="{{ produto.nome|lower }}" data-codigo="{{ produto.id|stringformat:'05d' }}" data-categoria="{% if produto.categoria %}{{ produto.categoria.nome }}{% endif %}">
                                <td>{{ produto.id|stringformat:"05d" }}</td>
                                <td><strong>{{ produto.nome }}</strong></td>
                                <td>
                                    {% if produto.categoria %}
                                    <span class="categoria-badge">{{ produto.categoria.emoji }} {{ produto.categoria.nome }}</span>
                                    {% else %}
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Sem categoria</span>
                                    {% endif %}
                                </td>
                                <td>{{ produto.quantidade_estoque }}</td>
                                <td>R$ {{ produto.preco }}</td>
                                <td style="position: relative;">
                                    <button class="btn-menu-acoes" onclick="toggleMenuAcoes(event, {{ produto.id }})">‚ãÆ</button>
                                    <div id="menu-acoes-{{ produto.id }}" class="menu-acoes-dropdown" style="display: none;">
                                        <button onclick="editarItem({{ produto.id }})">‚úèÔ∏è Editar</button>
                                        <button onclick="toggleAtivarItem({{ produto.id }}, {{ produto.ativo|yesno:'true,false' }})">
                                            {% if produto.ativo %}üö´ Inativar{% else %}‚úÖ Ativar{% endif %}
                                        </button>
                                        <button onclick="abrirModalExcluirItem({{ produto.id }}, '{{ produto.nome|escapejs }}')">üóëÔ∏è Excluir</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA: RELAT√ìRIOS -->
        <div id="tab-relatorios" class="tab-content {% if aba_ativa == 'relatorios' %}active{% endif %}">
            <h2 class="page-title">üìä Relat√≥rios e Dashboard</h2>
            
            <!-- Filtros de Per√≠odo -->
            <div class="relatorios-filtros">
                <div class="filtros-rapidos">
                    <button class="btn-filtro-rapido active" onclick="aplicarFiltroRapido('hoje')">Hoje</button>
                    <button class="btn-filtro-rapido" onclick="aplicarFiltroRapido('ontem')">Ontem</button>
                    <button class="btn-filtro-rapido" onclick="aplicarFiltroRapido('semana')">Esta Semana</button>
                    <button class="btn-filtro-rapido" onclick="aplicarFiltroRapido('mes')">Este M√™s</button>
                    <button class="btn-filtro-rapido" onclick="aplicarFiltroRapido('personalizado')">üìÖ Personalizado</button>
                </div>
                
                <div class="filtros-personalizados" id="filtros-personalizados" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data In√≠cio</label>
                            <input type="date" id="data-inicio" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Fim</label>
                            <input type="date" id="data-fim" class="form-control">
                        </div>
                        <button class="btn-action" onclick="carregarRelatorios()">ÔøΩ Buscar</button>
                    </div>
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="stats-grid-relatorios">
                <div class="stat-card-relatorio">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-vendas">R$ 0,00</div>
                        <div class="stat-label">Total em Vendas</div>
                    </div>
                </div>
                <div class="stat-card-relatorio">
                    <div class="stat-icon">üõí</div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-pedidos">0</div>
                        <div class="stat-label">Pedidos Realizados</div>
                    </div>
                </div>
                <div class="stat-card-relatorio">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <div class="stat-value" id="ticket-medio">R$ 0,00</div>
                        <div class="stat-label">Ticket M√©dio</div>
                    </div>
                </div>
                <div class="stat-card-relatorio">
                    <div class="stat-icon">üçΩÔ∏è</div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-itens">0</div>
                        <div class="stat-label">Itens Vendidos</div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Itens Mais Vendidos -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3>üèÜ Itens Mais Vendidos</h3>
                    <button class="btn-expandir" id="btn-expandir-top" onclick="toggleTopItens()">
                        Ver Top 10
                    </button>
                </div>
                <div class="top-itens-container" id="top-itens-container">
                    <div class="loading-message">Carregando...</div>
                </div>
            </div>

            <!-- Hist√≥rico de Vendas -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3>üìã Hist√≥rico de Vendas</h3>
                    <div class="section-actions">
                        <button class="btn-secondary" onclick="exportarPDF()">üìÑ PDF</button>
                        <button class="btn-secondary" onclick="exportarExcel()">üìä Excel</button>
                    </div>
                </div>
                
                <div class="historico-vendas">
                    <div class="table-wrapper-historico">
                        <table class="data-table data-table-header">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">Pedido</th>
                                    <th style="width: 20%;">Data/Hora</th>
                                    <th style="width: 20%;">Cliente</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Pagamento</th>
                                    <th style="width: 10%;">Itens</th>
                                    <th style="width: 10%;">Total</th>
                                </tr>
                            </thead>
                        </table>
                        
                        <div class="table-scroll-container-historico">
                            <table class="data-table">
                                <tbody id="historico-vendas-tbody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                            Carregando hist√≥rico...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA: LINKS -->
        <div id="tab-links" class="tab-content {% if aba_ativa == 'links' %}active{% endif %}">
            <h2 class="page-title">üîó Links de Acesso R√°pido</h2>
            
            <div class="links-grid">
                <div class="link-card">
                    <div class="link-icon">üë®‚Äçüç≥</div>
                    <h3>Cozinha</h3>
                    <p>Gest√£o de pedidos na cozinha</p>
                    <a href="{% url 'cozinha_dashboard' %}" target="_blank" class="btn-action">Abrir</a>
                </div>

                <div class="link-card">
                    <div class="link-icon">üìä</div>
                    <h3>Painel de Status</h3>
                    <p>Dashboard geral de pedidos</p>
                    <a href="{% url 'painel_status' %}" target="_blank" class="btn-action">Abrir</a>
                </div>

                <div class="link-card">
                    <div class="link-icon">üñ•Ô∏è</div>
                    <h3>Totem Autoatendimento</h3>
                    <p>Tela para clientes fazerem pedidos</p>
                    <a href="/autoatendimento/{{ user.empresa.id }}/" target="_blank" class="btn-action">Abrir</a>
                    <div class="link-url">
                        <input type="text" readonly value="{{ request.scheme }}://{{ request.get_host }}/autoatendimento/{{ user.empresa.id }}/" class="url-input">
                        <button class="btn-copy" onclick="copiarURL(this)">üìã</button>
                    </div>
                </div>

                <div class="link-card">
                    <div class="link-icon">üëÅÔ∏è</div>
                    <h3>Vis√£o Cliente</h3>
                    <p>Card√°pio do dia + Espelhamento do pedido em tempo real</p>
                    <a href="/cardapio/{{ user.empresa.id }}/" target="_blank" class="btn-action">Abrir</a>
                    <div class="link-url">
                        <input type="text" readonly value="{{ request.scheme }}://{{ request.get_host }}/cardapio/{{ user.empresa.id }}/" class="url-input">
                        <button class="btn-copy" onclick="copiarURL(this)">üìã</button>
                    </div>
                </div>

                {% if user.tipo == 'admin' %}
                <div class="link-card">
                    <div class="link-icon">‚öôÔ∏è</div>
                    <h3>Admin Django</h3>
                    <p>Painel administrativo completo</p>
                    <a href="/admin/" target="_blank" class="btn-action">Abrir</a>
                </div>
                {% endif %}

                <div class="link-card">
                    <div class="link-icon">üì±</div>
                    <h3>Acompanhamento</h3>
                    <p>Exemplo de tela de acompanhamento</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Use o QR Code gerado em cada pedido
                    </p>
                </div>
            </div>
        </div>

        <!-- ABA: USU√ÅRIOS -->
        <div id="tab-usuarios" class="tab-content {% if aba_ativa == 'usuarios' %}active{% endif %}">
            <h2 class="page-title">üë• Gest√£o de Usu√°rios</h2>
            
            <div style="margin-bottom: 1.5rem;">
                <button class="btn-action" onclick="window.location.href='/admin/authentication/usuario/add/'">+ Novo Usu√°rio</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usu√°rio</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in user.empresa.usuarios.all %}
                    <tr>
                        <td><strong>{{ usuario.username }}</strong></td>
                        <td>{{ usuario.email|default:"-" }}</td>
                        <td>
                            <span class="tipo-badge tipo-{{ usuario.tipo }}">
                                {{ usuario.get_tipo_display }}
                            </span>
                        </td>
                        <td>
                            {% if usuario.is_active %}
                            <span class="status-badge-user status-ativo">Ativo</span>
                            {% else %}
                            <span class="status-badge-user status-inativo">Inativo</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-table-action" onclick="abrirModalEditarUsuario({{ usuario.id }})">‚úèÔ∏è Editar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ABA: CONFIGURA√á√ïES -->
        <div id="tab-configuracoes" class="tab-content {% if aba_ativa == 'configuracoes' %}active{% endif %}">
            <h2 class="page-title">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            
            <div class="config-container">
                <!-- SUB-ABA: NOME DO SISTEMA -->
                <div class="config-section">
                    <div class="config-section-header">
                        <h3>üè∑Ô∏è Nome do Sistema</h3>
                        <p class="config-description">Personalize o nome que aparece no cabe√ßalho do sistema</p>
                    </div>
                    
                    <div class="config-form">
                        <div class="form-group">
                            <label class="form-label">Nome Atual: <strong>{{ user.empresa.nome }}</strong></label>
                            <input type="text" id="config-nome-sistema" class="form-control" placeholder="Digite o novo nome do sistema..." value="{{ user.empresa.nome }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Emoji (opcional)</label>
                            <input type="text" id="config-emoji-sistema" class="form-control" placeholder="üçΩÔ∏è" maxlength="2" style="width: 100px;">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">Cole um emoji aqui para aparecer ao lado do nome</small>
                        </div>
                        
                        <div class="config-preview">
                            <label class="form-label">Pr√©-visualiza√ß√£o:</label>
                            <div class="preview-header">
                                <span id="preview-nome">üçΩÔ∏è {{ user.empresa.nome }}</span>
                            </div>
                        </div>
                        
                        <button onclick="salvarNomeSistema()" class="btn-action">üíæ Salvar Altera√ß√µes</button>
                    </div>
                </div>
                
                <!-- FUTURAS SUB-ABAS -->
                <div class="config-section" style="opacity: 0.5; pointer-events: none;">
                    <div class="config-section-header">
                        <h3>üé® Cores e Tema</h3>
                        <p class="config-description">Em breve: Personalize as cores do sistema</p>
                    </div>
                </div>
                
                <div class="config-section" style="opacity: 0.5; pointer-events: none;">
                    <div class="config-section-header">
                        <h3>üñ®Ô∏è Impressora</h3>
                        <p class="config-description">Em breve: Configure impressoras para pedidos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √ÅREA FIXA DIREITA: PEDIDOS ATIVOS -->
    <div class="pedidos-ativos-sidebar" id="sidebar-pedidos" style="width: 280px !important; max-width: 280px !important;">
        <div class="sidebar-titulo">
            <span class="titulo-icon">üî•</span>
            <span class="titulo-texto">Pedidos Ativos</span>
            <span class="titulo-contador">({{ pedidos_abertos.count }})</span>
        </div>
        
        <!-- Estat√≠sticas em linha -->
        <div class="sidebar-stats" data-version="v2">
            <div class="sidebar-stat pendente">
                <span>‚è≥</span>
                <span id="sidebar-stat-pendente">{{ estatisticas.total_pendente|default:0 }}</span>
            </div>
            <div class="sidebar-stat preparando">
                <span>üë®‚Äçüç≥</span>
                <span id="sidebar-stat-preparando">{{ estatisticas.total_preparando|default:0 }}</span>
            </div>
            <div class="sidebar-stat pronto">
                <span>‚úÖ</span>
                <span id="sidebar-stat-pronto">{{ estatisticas.total_pronto|default:0 }}</span>
            </div>
            <div class="sidebar-stat tempo">
                <span>‚è±Ô∏è</span>
                <span id="sidebar-stat-tempo">--:--</span>
            </div>
        </div>
        
        <div class="pedidos-lista">
            {% for pedido in pedidos_abertos %}
            <div class="pedido-card-simples">
                <!-- Cabe√ßalho: Nome e Cron√¥metro -->
                <div class="pedido-cabecalho">
                    <span class="pedido-nome-cliente">{{ pedido.cliente_nome|default:"Cliente" }}</span>
                    <span class="pedido-cronometro" data-inicio="{{ pedido.criado_em.isoformat }}">
                        <span class="cronometro-icon">‚è±Ô∏è</span>
                        <span class="cronometro-tempo">00:00</span>
                    </span>
                </div>
                
                <!-- Meta: N√∫mero, Tipo, Pagamento -->
                <div class="pedido-meta-info">
                    <span>#{{ pedido.numero_pedido }}</span>
                    <span class="pedido-meta-separador">‚Ä¢</span>
                    <span>{{ pedido.get_tipo_display }}</span>
                    <span class="pedido-meta-separador">‚Ä¢</span>
                    <span>üí≥ {% if pedido.forma_pagamento %}{{ pedido.get_forma_pagamento_display }}{% else %}N√£o informado{% endif %}</span>
                </div>
                
                <!-- Lista de Itens -->
                <div class="pedido-itens-lista">
                    {% for item in pedido.itens.all %}
                    <div class="pedido-item-linha">
                        <span class="item-descricao">{{ item.quantidade }}x {{ item.produto.nome }}</span>
                        <span class="item-valor">R$ {{ item.subtotal }}</span>
                    </div>
                    {% endfor %}
                    
                    <!-- Total na √∫ltima linha -->
                    <div class="pedido-item-linha pedido-total-linha">
                        <span class="item-descricao">üí∞ Total:</span>
                        <span class="item-valor-total">R$ {{ pedido.total }}</span>
                    </div>
                </div>
                
                <!-- Observa√ß√µes -->
                {% if pedido.observacoes %}
                <div class="pedido-observacoes">
                    <span class="obs-label">üìù Obs:</span>
                    <span class="obs-texto">{{ pedido.observacoes }}</span>
                </div>
                {% endif %}
                
                <!-- Select de Status e Bot√µes na mesma linha -->
                <div class="pedido-acoes-linha">
                    <select class="pedido-status-select-inline" data-pedido-id="{{ pedido.id }}" onchange="alterarStatusPedido(this)">
                        <option value="pendente" {% if pedido.status == 'pendente' %}selected{% endif %}>‚è≥ Fila</option>
                        <option value="preparando" {% if pedido.status == 'preparando' %}selected{% endif %}>üë®‚Äçüç≥ Em preparo</option>
                        <option value="pronto" {% if pedido.status == 'pronto' %}selected{% endif %}>‚úÖ Pronto</option>
                        <option value="entregue" {% if pedido.status == 'entregue' %}selected{% endif %}>üéâ Entregue</option>
                    </select>
                    
                    <button class="btn-acao-quadrado btn-qr" onclick="mostrarQRCode('{{ pedido.qr_code }}')">
                        <span class="btn-icon-grande">üì±</span>
                    </button>
                    
                    <button class="btn-acao-quadrado btn-editar" onclick="abrirModalEditar({{ pedido.id }})">
                        <span class="btn-icon-grande">‚úèÔ∏è</span>
                    </button>
                    
                    <button class="btn-acao-quadrado btn-cancelar" onclick="abrirModalExcluirPedido({{ pedido.id }})">
                        <span class="btn-icon-grande">üóëÔ∏è</span>
                    </button>
                </div>
            </div>
            {% empty %}
            <p class="empty-message">Nenhum pedido ativo</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- MODAL QR CODE -->
<div id="modal-qrcode" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="fecharModal()">&times;</span>
        <h2>‚úÖ Pedido Criado!</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Escaneie o QR Code para acompanhar o pedido</p>
        <div id="qrcode-container"></div>
        <p id="qrcode-url"></p>
        <button onclick="fecharModal()" class="btn btn-primary" style="margin-top: 1.5rem; padding: 0.7rem 2rem;">Fechar</button>
    </div>
</div>

<!-- MODAL EXCLUIR PEDIDO -->
<div id="modal-excluir-pedido" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
        <span class="modal-close" onclick="fecharModalExcluirPedido()">&times;</span>
        <h2 style="color: #dc3545;">‚ö†Ô∏è Excluir Pedido</h2>
        
        <div style="margin: 1.5rem 0;">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Esta a√ß√£o √© <strong style="color: #dc3545;">IRREVERS√çVEL</strong> e ir√°:
            </p>
            <ul style="color: var(--text-secondary); margin-left: 1.5rem; line-height: 1.8;">
                <li>Devolver os itens ao estoque</li>
                <li>Remover os valores dos relat√≥rios</li>
                <li>Excluir permanentemente o pedido</li>
            </ul>
            
            <div class="form-group" style="margin-top: 1.5rem;">
                <label class="form-label">Para confirmar, digite <strong style="color: var(--btn-primary);">EXCLUIR</strong> no campo abaixo:</label>
                <input 
                    type="text" 
                    id="confirmar-exclusao-input" 
                    class="form-control" 
                    placeholder="Digite EXCLUIR"
                    style="text-transform: uppercase;"
                    oninput="validarCampoExclusao()"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                >
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="fecharModalExcluirPedido()" class="btn-secondary">Cancelar</button>
            <button id="btn-confirmar-exclusao" onclick="confirmarExclusaoPedido()" class="btn-primary" disabled style="background: #dc3545; opacity: 0.5; cursor: not-allowed;">
                üóëÔ∏è Excluir Pedido
            </button>
        </div>
    </div>
</div>

<!-- MODAL EDITAR USU√ÅRIO -->
<div id="modal-editar-usuario" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
        <span class="modal-close" onclick="fecharModalEditarUsuario()">&times;</span>
        <h2>üë§ Editar Usu√°rio</h2>
        
        <input type="hidden" id="usuario-id">
        
        <div class="form-group">
            <label class="form-label">Nome de Usu√°rio</label>
            <input type="text" id="usuario-username" class="form-control" placeholder="Digite o nome de usu√°rio">
        </div>
        
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="usuario-email" class="form-control" placeholder="Digite o email">
        </div>
        
        <div class="form-group">
            <label class="form-label">Tipo de Usu√°rio</label>
            <select id="usuario-tipo" class="form-control">
                <option value="admin">Administrador</option>
                <option value="gerente">Gerente</option>
                <option value="caixa">Operador de Caixa</option>
                <option value="cozinha">Cozinha</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Telefone</label>
            <input type="text" id="usuario-telefone" class="form-control" placeholder="Digite o telefone">
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="usuario-ativo" style="margin-right: 0.5rem;">
                Usu√°rio Ativo
            </label>
        </div>
        
        <div class="form-group">
            <label class="form-label">Nova Senha (deixe em branco para n√£o alterar)</label>
            <input type="password" id="usuario-senha" class="form-control" placeholder="Digite a nova senha">
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button onclick="fecharModalEditarUsuario()" class="btn-secondary">Cancelar</button>
            <button onclick="salvarUsuario()" class="btn-primary">üíæ Salvar</button>
        </div>
    </div>
</div>

<!-- MODAL EDITAR PEDIDO -->
<div id="modal-editar-pedido" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-editar" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="fecharModalEditar()">&times;</span>
        <h2>‚úèÔ∏è Editar Pedido</h2>
        
        <div class="modal-editar-container">
            <!-- Coluna 1: Dados do Pedido -->
            <div class="modal-editar-dados">
                <h3 style="color: var(--text-primary);">üìã Dados do Pedido</h3>
                
                <div class="form-group">
                    <label class="form-label">üë§ Nome do Cliente</label>
                    <input type="text" id="edit-cliente-nome" class="form-control" placeholder="Digite o nome do cliente...">
                </div>

                <div class="form-group">
                    <label class="form-label">üìç Refei√ß√£o</label>
                    <select id="edit-tipo-pedido" class="form-control">
                        <option value="balcao">‚õ™ Local</option>
                        <option value="delivery">üöó Viagem</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üí≥ Pagamento</label>
                    <select id="edit-forma-pagamento" class="form-control">
                        <option value="">Selecione...</option>
                        <option value="dinheiro">üíµ Dinheiro</option>
                        <option value="debito">üí≥ D√©bito</option>
                        <option value="credito">üí≥ Cr√©dito</option>
                        <option value="pix">üì± PIX</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üìù Observa√ß√µes</label>
                    <textarea id="edit-observacoes" class="form-control" rows="3" placeholder="Observa√ß√µes especiais do pedido..."></textarea>
                </div>
            </div>

            <!-- Coluna 2: Adicionar Produtos -->
            <div class="modal-editar-produtos">
                <h3 style="color: var(--text-primary);">‚ûï Adicionar Produtos</h3>
                
                <div class="busca-produto" style="margin-bottom: 0.6rem; flex-shrink: 0;">
                    <input type="text" id="edit-busca-item" class="form-control" placeholder="üîç Buscar produto...">
                </div>

                <div class="edit-produtos-grid" id="edit-produtos-grid">
                    {% for produto in produtos %}
                    <div class="edit-produto-card" data-nome="{{ produto.nome|lower }}" data-codigo="{{ produto.id }}" onclick="adicionarProdutoEdicao({{ produto.id }}, '{{ produto.nome|escapejs }}', {{ produto.preco }})">
                        <div class="edit-produto-nome">{{ produto.nome }}</div>
                        <div class="edit-produto-preco">R$ {{ produto.preco }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Coluna 3: Carrinho -->
            <div class="modal-editar-carrinho">
                <h3 style="color: var(--text-primary);">üõçÔ∏è Carrinho</h3>
                
                <div class="edit-itens-lista" id="edit-itens-lista">
                    <!-- Itens ser√£o inseridos aqui via JavaScript -->
                </div>

                <div class="edit-total-section">
                    <div class="total-label">üí∞ Total:</div>
                    <div class="total-valor">R$ <span id="edit-total-pedido">0.00</span></div>
                </div>
            </div>
        </div>

        <div class="modal-editar-footer">
            <button onclick="fecharModalEditar()" class="btn-secondary">Cancelar</button>
            <button onclick="salvarEdicaoPedido()" class="btn-primary">üíæ Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<!-- MODAL PRODUTO (CRIAR/EDITAR) -->
<div id="modal-produto" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-produto" onclick="event.stopPropagation()">
        <h2 id="modal-produto-titulo">‚ûï Novo Produto</h2>
        
        <div class="modal-produto-container">
            <input type="hidden" id="produto-id" value="">
            
            <!-- COLUNA ESQUERDA: INFORMA√á√ïES -->
            <div class="modal-produto-coluna-esquerda">
                <div class="form-group">
                    <label class="form-label">üçΩÔ∏è Nome do Produto</label>
                    <input type="text" id="produto-nome" class="form-control" placeholder="Ex: X-Burger, Caf√© Expresso..." required autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                
                <div class="form-row-inline">
                    <div class="form-group" style="flex: 1.5;">
                        <label class="form-label">üí∞ Pre√ßo (R$)</label>
                        <input type="number" id="produto-preco" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">üì¶ Estoque/Qnt.</label>
                        <input type="number" id="produto-quantidade" class="form-control" placeholder="0" min="0" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">üìÅ Categoria <span style="color: #e74c3c;">*</span></label>
                    <select id="produto-categoria" class="form-control" required>
                        <option value="">Selecione uma categoria...</option>
                        <!-- Categorias ser√£o carregadas via JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Tempo de Preparo (min) - Opcional</label>
                    <input type="number" id="produto-tempo-preparo" class="form-control" placeholder="15" min="1" value="15">
                </div>

                <div class="form-group">
                    <label class="form-label">üìù Descri√ß√£o - Opcional</label>
                    <input type="text" id="produto-descricao" class="form-control" placeholder="Descri√ß√£o do produto...">
                </div>
            </div>

            <!-- COLUNA DIREITA: IMAGEM E STATUS -->
            <div class="modal-produto-coluna-direita">
                <div class="form-group">
                    <label class="form-label">üñºÔ∏è Imagem do Produto</label>
                    <div class="produto-imagem-upload">
                        <input type="file" id="produto-imagem" accept="image/*" style="display: none;" onchange="previewImagemProduto(event)">
                        <div class="produto-imagem-preview" id="produto-imagem-preview" onclick="document.getElementById('produto-imagem').click()">
                            <div class="preview-placeholder">
                                <span style="font-size: 3rem;">üì∑</span>
                                <p>Clique para adicionar imagem</p>
                                <small>JPG, PNG ou GIF (m√°x. 5MB)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="toggle-switch-label">
                        <input type="checkbox" id="produto-ativo" checked>
                        <span class="toggle-switch-text">‚úÖ Produto dispon√≠vel no card√°pio</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="modal-produto-footer">
            <button onclick="fecharModalProduto()" class="btn-secondary">Cancelar</button>
            <button onclick="salvarProduto()" class="btn-primary" id="btn-salvar-produto">üíæ Salvar Produto</button>
        </div>
    </div>
</div>

<!-- MODAL CATEGORIAS -->
<div id="modal-categorias" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-categorias" onclick="event.stopPropagation()">
        <h2>üìÇ Gerenciar Categorias</h2>
        
        <div class="modal-categorias-container">
            <!-- COLUNA ESQUERDA: NOVA CATEGORIA -->
            <div class="categorias-coluna-esquerda">
                <h3 class="categoria-section-title">‚ûï Nova Categoria</h3>
                
                <div class="form-group" style="margin-bottom: 0.6rem;">
                    <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Nome da Categoria</label>
                    <input type="text" id="nova-categoria-nome" class="form-control" placeholder="Ex: Lanches, Bebidas..." style="margin: 0; font-size: 0.9rem; padding: 0.5rem;" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                
                <div class="form-group" style="margin-bottom: 0.6rem; position: relative;">
                    <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Emoji</label>
                    <input type="text" id="nova-categoria-emoji" class="form-control" value="üçΩÔ∏è" readonly onclick="abrirSeletorEmoji()" style="margin: 0; text-align: center; font-size: 1.4rem; cursor: pointer; padding: 0.5rem;">
                    
                    <!-- Seletor de Emoji -->
                    <div id="emoji-selector" style="display: none;">
                        <div>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçî')">üçî</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçï')">üçï</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üå≠')">üå≠</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('ü•™')">ü•™</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üåÆ')">üåÆ</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçü')">üçü</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçó')">üçó</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('ü•ì')">ü•ì</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçù')">üçù</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçú')">üçú</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üç∞')">üç∞</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üßÅ')">üßÅ</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üç™')">üç™</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üç©')">üç©</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üç¶')">üç¶</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('‚òï')">‚òï</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üßÉ')">üßÉ</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('ü•§')">ü•§</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üßã')">üßã</button>
                            <button class="emoji-btn" onclick="selecionarEmoji('üçπ')">üçπ</button>
                        </div>
                    </div>
                </div>
                
                <button onclick="salvarNovaCategoria()" class="btn-primary" style="width: 100%; padding: 0.6rem; font-size: 0.85rem;">Adicionar Categoria</button>
            </div>
            
            <!-- COLUNA DIREITA: CATEGORIAS CADASTRADAS -->
            <div class="categorias-coluna-direita">
                <h3 class="categoria-section-title">üìã Categorias Cadastradas</h3>
                <div id="lista-categorias">
                    <!-- Categorias ser√£o carregadas aqui via JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="modal-categorias-footer">
            <button onclick="fecharModalCategorias()" class="btn-secondary">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL CONFIGURA√á√ÉO DE COMBO -->
<div id="modal-combo" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-combo" onclick="event.stopPropagation()">
        <h2 id="modal-combo-titulo">üéÅ Configurar Combo</h2>
        
        <div class="modal-combo-container">
            <input type="hidden" id="combo-produto-id" value="">
            
            <!-- COLUNA ESQUERDA: INFORMA√á√ïES DO COMBO -->
            <div class="combo-coluna-esquerda">
                <h3 class="combo-section-title">‚ÑπÔ∏è Informa√ß√µes do Combo</h3>
                
                <div class="form-group">
                    <label class="form-label">üçΩÔ∏è Nome do Combo</label>
                    <input type="text" id="combo-nome" class="form-control" placeholder="Ex: Combo Pastel, Combo Super..." required autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Pre√ßo do Combo (R$)</label>
                    <input type="number" id="combo-preco" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                </div>
                
                <div class="combo-info-box">
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                        üí° O combo ter√° um pre√ßo fixo independente das escolhas do cliente.
                    </p>
                </div>
            </div>
            
            <!-- COLUNA DIREITA: SLOTS DO COMBO -->
            <div class="combo-coluna-direita">
                <div class="slots-header">
                    <h3 class="combo-section-title">üìã Slots de Escolha</h3>
                    <button onclick="adicionarSlotCombo()" class="btn-action btn-small">+ Adicionar Slot</button>
                </div>
                
                <div id="combo-slots-lista" class="slots-lista">
                    <!-- Slots ser√£o adicionados aqui dinamicamente -->
                    <div class="empty-slots-message">
                        <p>Nenhum slot adicionado ainda.</p>
                        <small>Clique em "+ Adicionar Slot" para come√ßar</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-combo-footer">
            <button onclick="fecharModalCombo()" class="btn-secondary">Cancelar</button>
            <button onclick="salvarCombo()" class="btn-primary">üíæ Salvar Combo</button>
        </div>
    </div>
</div>

<!-- MODAL SELE√á√ÉO DE COMBO (PDV) -->
<div id="modal-selecao-combo" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-selecao-combo" onclick="event.stopPropagation()">
        <h2 id="modal-selecao-titulo">üéÅ Monte seu Combo</h2>
        
        <div class="modal-selecao-container">
            <input type="hidden" id="selecao-combo-id" value="">
            
            <!-- Informa√ß√µes do Combo -->
            <div class="selecao-info">
                <div class="selecao-nome" id="selecao-combo-nome"></div>
                <div class="selecao-preco" id="selecao-combo-preco"></div>
            </div>
            
            <!-- Slots de Sele√ß√£o -->
            <div id="selecao-slots-lista" class="selecao-slots-lista">
                <!-- Slots ser√£o renderizados aqui -->
            </div>
        </div>

        <div class="modal-selecao-footer">
            <button onclick="fecharModalSelecaoCombo()" class="btn-secondary">Cancelar</button>
            <button onclick="confirmarSelecaoCombo()" class="btn-primary">‚úÖ Adicionar ao Pedido</button>
        </div>
    </div>
</div>

<!-- MODAL SELECIONAR PRODUTO PARA SLOT -->
<div id="modal-selecionar-produto-slot" class="modal" onclick="fecharModalSeForaDoConteudo(event)">
    <div class="modal-content modal-selecao-combo" onclick="event.stopPropagation()">
        <h2>üçî Selecionar Produto para o Slot</h2>
        
        <div class="modal-selecao-container">
            <!-- Busca -->
            <div style="margin-bottom: 1rem;">
                <input type="text" id="busca-produto-slot" placeholder="üîç Buscar produto..." 
                       style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);"
                       oninput="filtrarProdutosSlot()" autocomplete="off">
            </div>
            
            <!-- Lista de Produtos -->
            <div id="lista-produtos-slot" class="selecao-slots-lista" style="max-height: 400px; overflow-y: auto;">
                <!-- Produtos ser√£o renderizados aqui -->
            </div>
        </div>

        <div class="modal-selecao-footer">
            <button onclick="fecharModalSelecionarProdutoSlot()" class="btn-secondary">Cancelar</button>
        </div>
    </div>
</div>

<style>
#modal-qrcode .modal-content h2 {
    color: var(--btn-primary);
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

#qrcode-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 1.5rem auto;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    width: fit-content;
}

#qrcode-url {
    color: var(--text-secondary);
    font-size: 0.85rem;
    word-break: break-all;
    margin-top: 1rem;
    padding: 0.5rem;
    background: var(--bg-primary);
    border-radius: 6px;
}

/* MODAL EDITAR PEDIDO */
.modal-editar {
    width: 92vw !important;
    max-width: 1800px !important;
    height: 90vh !important;
    max-height: 90vh !important;
    margin: 5vh auto !important;
    overflow: hidden;
    padding: 0;
    display: flex;
    flex-direction: column;
}

.modal-editar h2 {
    padding: 0.6rem 1.2rem;
    margin: 0;
    background: transparent;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    font-size: 1.1rem;
    flex-shrink: 0;
}

.modal-editar-container {
    display: grid;
    grid-template-columns: 280px 1fr 340px;
    gap: 0;
    flex: 1;
    overflow: hidden;
}

/* COLUNA 1: DADOS DO PEDIDO */
.modal-editar-dados {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    padding: 1rem;
    overflow-y: auto;
    border-right: 1px solid var(--border-color);
    background: var(--bg-header);
}

.modal-editar-dados h3 {
    font-size: 0.95rem;
    margin: 0 0 0.5rem 0;
}

.modal-editar-dados .form-group {
    margin-bottom: 0.4rem;
}

.modal-editar-dados .form-label {
    font-size: 0.8rem;
    margin-bottom: 0.3rem;
}

.modal-editar-dados .form-control {
    padding: 0.6rem 0.7rem;
    font-size: 0.85rem;
}

.modal-editar-dados textarea.form-control {
    min-height: 70px;
    resize: vertical;
}

.modal-editar-dados::-webkit-scrollbar {
    width: 5px;
}

.modal-editar-dados::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

.modal-editar-dados::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

/* COLUNA 2: PRODUTOS DISPON√çVEIS */
.modal-editar-produtos {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow: hidden;
}

.modal-editar-produtos h3 {
    margin: 0 0 0.6rem 0;
    flex-shrink: 0;
    font-size: 0.95rem;
}

/* COLUNA 3: CARRINHO */
.modal-editar-carrinho {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow: hidden;
    border-left: 1px solid var(--border-color);
    background: var(--bg-header);
}

.modal-editar-carrinho h3 {
    margin: 0 0 0.6rem 0;
    flex-shrink: 0;
    font-size: 0.95rem;
}

.edit-itens-lista {
    flex: 1;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.6rem;
    background: var(--bg-primary);
    margin-bottom: 0.8rem;
}

.edit-itens-lista::-webkit-scrollbar {
    width: 5px;
}

.edit-itens-lista::-webkit-scrollbar-track {
    background: transparent;
}

.edit-itens-lista::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.edit-item-linha {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    padding: 0.6rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 0.3rem !important;
}

.edit-item-info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.edit-item-nome {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.9rem;
}

.edit-item-detalhes {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.edit-item-acoes {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.4rem;
}

.edit-item-acoes-qty {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.edit-total-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 1rem;
    background: var(--bg-primary);
    border: 2px solid var(--btn-primary);
    border-radius: 8px;
    flex-shrink: 0; 0;
}

.edit-total-section .total-label {
    font-size: 1.1rem;
    font-weight: 600;
}

.edit-total-section .total-valor {
    font-size: 1.3rem;
    font-weight: bold;
}

.edit-produtos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.6rem;
    flex: 1;
    overflow-y: auto;
    padding-right: 0.3rem;
}

.edit-produtos-grid::-webkit-scrollbar {
    width: 5px;
}

.edit-produtos-grid::-webkit-scrollbar-track {
    background: transparent;
}

.edit-produtos-grid::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.edit-produto-card {
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.6rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    height: fit-content;
}

.edit-produto-card:hover {
    border-color: var(--btn-primary);
    background: #252525;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 162, 58, 0.2);
}

.edit-produto-nome {
    color: var(--text-primary);
    font-size: 0.8rem;
    font-weight: 600;
    line-height: 1.3;
    min-height: 2.4em;
}

.edit-produto-preco {
    color: var(--btn-primary);
    font-size: 0.9rem;
    font-weight: bold;
}

.modal-editar-footer {
    display: flex;
    gap: 0.8rem;
    padding: 0.8rem 1.2rem;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

/* MODAL PRODUTO */
.modal-produto {
    width: 800px !important;
    max-width: 95vw !important;
    max-height: 90vh !important;
    overflow: hidden;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0 !important;
}

@media (max-height: 700px) {
    .modal-produto {
        max-height: 95vh !important;
        top: 2.5vh;
        transform: translateX(-50%);
    }
}

@media (max-width: 768px) {
    .modal-produto {
        width: 95vw !important;
    }
}

.modal-produto h2 {
    padding: 0.6rem 1.2rem;
    margin: 0;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    font-size: 1.1rem;
}

.modal-produto-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.2rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .modal-produto-container {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

.modal-produto-container::-webkit-scrollbar {
    width: 8px;
}

.modal-produto-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

.modal-produto-container::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

.modal-produto-container::-webkit-scrollbar-thumb:hover {
    background: #e89530;
}

.modal-produto-coluna-esquerda,
.modal-produto-coluna-direita {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.modal-produto-coluna-esquerda .form-group,
.modal-produto-coluna-direita .form-group {
    display: flex;
    flex-direction: column;
}

.modal-produto-coluna-esquerda .form-row-inline {
    display: flex;
    gap: 0.8rem;
}

.modal-produto-coluna-esquerda .form-row-inline .form-group {
    display: flex;
    flex-direction: column;
}

.modal-produto-coluna-esquerda .form-label,
.modal-produto-coluna-direita .form-label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: var(--text-primary);
}

.modal-produto-coluna-esquerda .form-control,
.modal-produto-coluna-direita .form-control {
    padding: 0.6rem;
    font-size: 0.9rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.modal-produto-coluna-esquerda .form-control:focus,
.modal-produto-coluna-direita .form-control:focus {
    outline: none;
    border-color: var(--btn-primary);
    box-shadow: 0 0 0 3px rgba(244, 162, 58, 0.1);
}

.produto-imagem-upload {
    margin-top: 0.5rem;
}

.produto-imagem-preview {
    width: 100%;
    height: 200px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--bg-primary);
    overflow: hidden;
}

.produto-imagem-preview:hover {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.05);
}

.produto-imagem-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.preview-placeholder {
    text-align: center;
    color: var(--text-secondary);
}

.preview-placeholder p {
    margin: 0.5rem 0 0.3rem 0;
    font-weight: 600;
}

.preview-placeholder small {
    font-size: 0.75rem;
}

.toggle-switch-label {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    cursor: pointer;
    padding: 0.8rem;
    background: var(--bg-primary);
    border-radius: 6px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.toggle-switch-label:hover {
    background: rgba(244, 162, 58, 0.05);
}

.toggle-switch-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.toggle-switch-text {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-produto-footer {
    display: flex;
    gap: 0.8rem;
    padding: 1rem 1.5rem;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    background: var(--bg-header);
}

/* MODAL CATEGORIAS */
.modal-categorias {
    width: 850px !important;
    max-width: 90vw !important;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    margin: 5vh auto !important;
    position: relative;
    top: 50%;
    transform: translateY(-50%);
    overflow: visible;
}

@media (max-width: 768px) {
    .modal-categorias {
        width: 92vw !important;
        max-height: 85vh;
        margin: 0 auto !important;
    }
}

@media (min-width: 1200px) {
    .modal-categorias {
        width: 950px !important;
        max-width: 85vw !important;
    }
}

.modal-categorias h2 {
    padding: 0.6rem 1.2rem;
    margin: 0;
    background: transparent;
    color: var(--text-primary);
    border-radius: 12px 12px 0 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 1.1rem;
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .modal-categorias h2 {
        font-size: 1.1rem;
        padding: 0.6rem 1.2rem;
    }
}

.modal-categorias-container {
    flex: 1;
    overflow: visible;
    padding: 1rem;
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 1rem;
    min-height: 0;
}

@media (max-width: 968px) {
    .modal-categorias-container {
        grid-template-columns: 1fr;
        overflow-y: auto;
    }
}

.categorias-coluna-esquerda {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    padding: 1rem;
    background: var(--bg-header);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    height: fit-content;
    position: relative;
    overflow: visible;
    z-index: 10;
}

.categorias-coluna-direita {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    overflow-y: auto;
    overflow-x: visible;
    padding: 1rem;
    background: var(--bg-header);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.categoria-section-title {
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0 0 0.6rem 0;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-categorias-container::-webkit-scrollbar {
    width: 8px;
}

.modal-categorias-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

.modal-categorias-container::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

.modal-categorias-container::-webkit-scrollbar-thumb:hover {
    background: var(--btn-hover);
}

.nova-categoria-section,
.categorias-lista-section {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.2rem;
}

@media (max-width: 768px) {
    .nova-categoria-section,
    .categorias-lista-section {
        padding: 1rem;
    }
}

.nova-categoria-section h3,
.categorias-lista-section h3 {
    color: var(--text-primary);
    font-size: 1rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.nova-categoria-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    flex-wrap: wrap;
}

@media (max-width: 600px) {
    .nova-categoria-form {
        flex-direction: column;
        align-items: stretch;
    }
    
    .nova-categoria-form > div {
        width: 100% !important;
        min-width: 100% !important;
    }
    
    .nova-categoria-form button {
        width: 100%;
    }
}

.emoji-btn {
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.6rem;
    font-size: 1.6rem;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.emoji-btn:hover {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.2);
    transform: scale(1.05);
}

.emoji-btn.emoji-selected {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.3);
    box-shadow: 0 0 0 3px rgba(244, 162, 58, 0.2);
}

.emoji-btn.emoji-selected::after {
    content: '‚úì';
    position: absolute;
    bottom: 2px;
    right: 2px;
    font-size: 0.7rem;
    background: var(--btn-primary);
    color: var(--bg-primary);
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

@media (max-width: 968px) {
    .emoji-btn {
        font-size: 1.4rem;
        padding: 0.5rem;
    }
}

@media (max-width: 768px) {
    .emoji-btn {
        font-size: 1.3rem;
        padding: 0.4rem;
    }
    
    .emoji-btn.emoji-selected::after {
        width: 14px;
        height: 14px;
        font-size: 0.6rem;
    }
}

@media (max-width: 480px) {
    .emoji-btn {
        font-size: 1.2rem;
        padding: 0.3rem;
    }
    
    .emoji-btn.emoji-selected::after {
        width: 12px;
        height: 12px;
        font-size: 0.55rem;
    }
}

#emoji-selector {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 0.3rem;
    padding: 0.6rem;
    background: var(--bg-primary);
    border: 2px solid var(--btn-primary);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
}

#emoji-selector > div {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.4rem;
    max-height: 160px;
    overflow-y: auto;
    overflow-x: hidden;
}

@media (max-width: 968px) {
    #emoji-selector > div {
        grid-template-columns: repeat(5, 1fr);
        max-height: 140px;
    }
}

@media (max-width: 768px) {
    #emoji-selector > div {
        grid-template-columns: repeat(4, 1fr);
        max-height: 120px;
        gap: 0.3rem;
    }
}

@media (max-width: 480px) {
    #emoji-selector {
        padding: 0.5rem;
    }
    
    #emoji-selector > div {
        grid-template-columns: repeat(4, 1fr);
        max-height: 100px;
        gap: 0.25rem;
    }
}

#emoji-selector > div::-webkit-scrollbar {
    width: 8px;
}

#emoji-selector > div::-webkit-scrollbar-track {
    background: var(--bg-card);
    border-radius: 4px;
}

#emoji-selector > div::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

#emoji-selector > div::-webkit-scrollbar-thumb:hover {
    background: var(--btn-hover);
}

.categoria-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.7rem 0.8rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    transition: all 0.2s;
    flex-wrap: wrap;
}

.categoria-item.categoria-sistema {
    background: rgba(52, 152, 219, 0.05);
    border-color: rgba(52, 152, 219, 0.3);
}

@media (max-width: 768px) {
    .categoria-item {
        padding: 0.7rem;
        gap: 0.7rem;
    }
}

.categoria-item:hover {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.05);
}

.categoria-item.categoria-sistema:hover {
    border-color: rgba(52, 152, 219, 0.5);
    background: rgba(52, 152, 219, 0.08);
}

.categoria-emoji {
    font-size: 1.5rem;
    width: 32px;
    text-align: center;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.2s;
}

.categoria-emoji:hover {
    transform: scale(1.15);
}

@media (max-width: 768px) {
    .categoria-emoji {
        font-size: 1.3rem;
        width: 28px;
    }
}

.categoria-nome-container {
    flex: 1;
    min-width: 120px;
}

.categoria-nome {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.9rem;
    word-break: break-word;
    line-height: 1.3;
}

.categoria-nome-input {
    width: 100%;
    background: var(--bg-primary);
    border: 2px solid var(--btn-primary);
    color: var(--text-primary);
    padding: 0.4rem 0.6rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
}

.categoria-nome-input:focus {
    outline: none;
    border-color: var(--btn-hover);
}

@media (max-width: 768px) {
    .categoria-nome {
        font-size: 0.85rem;
    }
    
    .categoria-nome-input {
        font-size: 0.85rem;
    }
}

.categoria-acoes {
    display: flex;
    gap: 0.4rem;
    flex-shrink: 0;
}

.categoria-badge {
    display: inline-block;
    padding: 0.3rem 0.7rem;
    background: rgba(244, 162, 58, 0.1);
    border: 1px solid rgba(244, 162, 58, 0.3);
    border-radius: 4px;
    font-size: 0.85rem;
    color: var(--text-primary);
    white-space: nowrap;
}

.emoji-selector-inline {
    width: 100%;
    flex-basis: 100%;
}

#lista-categorias {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    overflow-y: auto;
    flex: 1;
    padding-right: 0.4rem;
    min-height: 300px;
    max-height: 450px;
}

#lista-categorias::-webkit-scrollbar {
    width: 8px;
}

#lista-categorias::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

#lista-categorias::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

#lista-categorias::-webkit-scrollbar-thumb:hover {
    background: var(--btn-hover);
}

.modal-categorias-footer {
    display: flex;
    gap: 0.8rem;
    padding: 0.8rem 1.2rem;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    background: var(--bg-header);
}

@media (max-width: 768px) {
    .modal-categorias-footer {
        padding: 0.7rem 1rem;
    }
}

.btn-secondary:hover {
    border-color: var(--btn-primary);
    color: var(--btn-primary);
}

.btn-primary {
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    padding: 0.6rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: var(--btn-hover);
    transform: translateY(-1px);
}

.btn-table-action {
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    padding: 0.4rem 0.9rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-table-action:hover {
    background: var(--btn-hover);
    transform: translateY(-1px);
    text-decoration: none;
}

/* Menu de a√ß√µes (tr√™s pontos) */
.btn-menu-acoes {
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    transition: all 0.2s;
    line-height: 1;
}

.btn-menu-acoes:hover {
    background: var(--bg-secondary);
}

.menu-acoes-dropdown {
    position: absolute;
    right: 0;
    top: 100%;
    background: #1A1A1A;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    z-index: 9999;
    min-width: 150px;
    margin-top: 0.3rem;
}

/* Garantir que a c√©lula da tabela tenha position relative e overflow visible */
#tabela-estoque td:last-child {
    position: relative;
    overflow: visible !important;
}

#tabela-estoque tr {
    overflow: visible !important;
}

#tabela-estoque tbody {
    overflow: visible !important;
}

.menu-acoes-dropdown button {
    display: block;
    width: 100%;
    padding: 0.7rem 1rem;
    background: transparent;
    border: none;
    color: var(--text-primary);
    text-align: left;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    border-bottom: 1px solid var(--border-color);
}

.menu-acoes-dropdown button:last-child {
    border-bottom: none;
}

.menu-acoes-dropdown button:hover {
    background: var(--bg-primary);
    color: var(--btn-primary);
}

@media (max-width: 1400px) {
    .modal-editar-container {
        grid-template-columns: 260px 1fr 320px;
    }
}

@media (max-width: 1200px) {
    .modal-editar {
        width: 95vw !important;
        height: 92vh !important;
        max-height: 92vh !important;
        margin: 4vh auto !important;
    }
    
    .modal-editar-container {
        grid-template-columns: 1fr;
        overflow-y: auto;
    }
    
    .modal-editar-dados,
    .modal-editar-carrinho {
        border: none;
        border-bottom: 1px solid var(--border-color);
    }
    
    .edit-produtos-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .edit-itens-lista {
        min-height: 300px;
    }
}
</style>

<style>
/* NOVA PALETA DE CORES */
:root {
    --bg-primary: #0B0B0B;
    --bg-header: #1A1A1A;
    --bg-card: #202020;
    --border-color: #2E2E2E;
    --text-primary: #FFFFFF;
    --text-secondary: #BDBDBD;
    --btn-primary: #F4A23A;
    --btn-hover: #D98A1F;
    --btn-text: #111111;
}

body {
    background: var(--bg-primary) !important;
}

/* TOAST NOTIFICATIONS */
.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 16px 24px;
    border-radius: 8px;
    color: white;
    font-size: 15px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    max-width: 400px;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast-success {
    background: #28a745;
}

.toast-error {
    background: #dc3545;
}

.toast-info {
    background: #17a2b8;
}

/* NOVO PEDIDO - LAYOUT ESPEC√çFICO */
.novo-pedido-layout {
    display: flex;
    gap: 0.8rem;
    height: calc(100vh - 45px - 1.6rem);
    overflow: hidden;
    flex: 1;
}

/* SE√á√ÉO CARD√ÅPIO (ESQUERDA) */
.cardapio-section {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 0.3rem;
}

.cardapio-section::-webkit-scrollbar {
    width: 4px;
}

.cardapio-section::-webkit-scrollbar-track {
    background: transparent;
}

.cardapio-section::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.cardapio-section::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* SE√á√ÉO FORMUL√ÅRIO (CENTRO) */
.pedido-form-section {
    width: 347px;
    min-width: 347px;
    max-width: 347px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 0.3rem;
}

.pedido-form-section::-webkit-scrollbar {
    width: 4px;
}

.pedido-form-section::-webkit-scrollbar-track {
    background: transparent;
}

.pedido-form-section::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.pedido-form-section::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
}

.cardapio-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    flex-shrink: 0;
}

.cardapio-header h3 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin: 0;
    font-weight: normal;
}

.items-count {
    background: var(--bg-card);
    color: var(--text-secondary);
    padding: 0.3rem 0.8rem;
    border-radius: 16px;
    font-size: 0.8rem;
    border: 1px solid var(--border-color);
}

.busca-produto {
    margin-bottom: 0.8rem;
    flex-shrink: 0;
}

.busca-produto .form-control {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
    padding: 0.7rem 0.9rem;
    font-size: 0.9rem;
}

.busca-produto .form-control::placeholder {
    color: var(--text-secondary);
}

.produtos-cardapio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.8rem;
    flex: 1;
    overflow: visible;
    grid-auto-rows: min-content;
}

.produto-card-cardapio {
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    position: relative;
    height: auto;
}

.produto-card-cardapio:hover {
    border-color: var(--btn-primary);
    background: #252525;
    transform: translateY(-2px);
}

.produto-card-info {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}

.produto-card-info h4 {
    color: var(--text-primary);
    font-size: 1rem;
    margin: 0;
    font-weight: 600;
    line-height: 1.4;
    word-wrap: break-word;
    hyphens: auto;
}

.produto-codigo {
    color: #6c757d;
    font-size: 0.75rem;
    font-weight: 500;
}

.produto-card-preco {
    color: var(--btn-primary);
    font-size: 1.2rem;
    font-weight: bold;
    margin-top: 0.3rem;
}

.produto-badge-estoque {
    position: absolute;
    top: 0.8rem;
    right: 0.8rem;
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    padding: 0.25rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-quantidade-tabela {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    padding: 0.3rem 0.7rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-block;
}

.coluna-quantidade {
    text-align: center;
}

/* Centralizar toggles na tabela do card√°pio */
#tabela-cardapio td {
    vertical-align: middle;
}

#tabela-cardapio td:nth-child(3),
#tabela-cardapio td:nth-child(4) {
    text-align: center;
}

#tabela-cardapio .toggle-switch {
    margin: 0 auto;
    display: inline-block;
}

/* SE√á√ÉO FORMUL√ÅRIO (DIREITA) */
.pedido-form-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}

.form-header h3 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin: 0;
    font-weight: normal;
    flex-shrink: 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-bottom: 0;
}

.form-label {
    color: var(--text-primary);
    font-weight: normal;
    font-size: 0.8rem;
}

.form-control {
    background: var(--bg-primary) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
    padding: 0.6rem 0.7rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.form-control:focus {
    border-color: var(--btn-primary) !important;
    outline: none;
}

.form-control::placeholder {
    color: var(--text-secondary);
    opacity: 0.6;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

textarea.form-control {
    resize: vertical;
    min-height: 60px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

textarea.form-control::placeholder {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-secondary);
    opacity: 0.6;
}
}

/* SE√á√ÉO DE ITENS */
.itens-section {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 300px;
    flex-shrink: 0;
}

.itens-header {
    background: var(--bg-primary);
    padding: 0.5rem 0.7rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.85rem;
    flex-shrink: 0;
}

.lista-itens-pedido {
    overflow-y: auto;
    padding: 0.6rem;
    background: var(--bg-primary);
    flex: 1;
    min-height: 150px;
}

.lista-itens-pedido::-webkit-scrollbar {
    width: 4px;
}

.lista-itens-pedido::-webkit-scrollbar-track {
    background: transparent;
}

.lista-itens-pedido::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.lista-itens-pedido::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
}

.carrinho-vazio {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.carrinho-vazio-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.carrinho-vazio p {
    margin: 0.5rem 0;
    font-weight: 400 !important;
    color: var(--text-secondary);
    font-size: 0.95rem;
}

.carrinho-vazio small {
    color: var(--text-secondary);
    opacity: 0.7;
    font-size: 0.85rem;
}

.item-carrinho {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 0.4rem;
}

.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    min-width: 0;
}

.item-nome {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-detalhes {
    color: var(--text-secondary);
    font-size: 0.75rem;
    white-space: nowrap;
}

.item-acoes {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    flex-shrink: 0;
}

.btn-qty {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    width: 26px;
    height: 26px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-qty:hover {
    background: var(--btn-primary);
    border-color: var(--btn-primary);
    color: var(--btn-text);
}

.item-quantidade {
    color: var(--text-primary);
    font-weight: bold;
    min-width: 24px;
    text-align: center;
    font-size: 0.85rem;
}

.btn-remove {
    background: transparent;
    border: 1px solid var(--border-color);
    color: #dc3545;
    width: 26px;
    height: 26px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-remove:hover {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
}

/* TOTAL DO PEDIDO */
.total-pedido-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0.6rem;
    background: transparent;
    border: none;
    border-radius: 4px;
    flex-shrink: 0;
}

.total-label {
    font-size: 1.1rem;
    color: var(--btn-primary);
    font-weight: normal;
}

.total-valor {
    font-size: 1.1rem;
    color: var(--btn-primary);
    font-weight: normal;
}

/* BOT√ÉO FINALIZAR */
.btn-finalizar-pedido-full {
    width: 100%;
    padding: 0.7rem;
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.btn-finalizar-pedido-full:hover {
    background: var(--btn-hover);
    transform: translateY(-1px);
}

.btn-finalizar-pedido-full:disabled {
    background: var(--border-color);
    color: var(--text-secondary);
    cursor: not-allowed;
    transform: none;
}
    width: 100%;
    padding: 0.85rem;
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 400 !important;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.btn-finalizar-pedido-full:hover {
    background: var(--btn-hover);
}

.btn-finalizar-pedido-full:disabled {
    background: var(--border-color);
    color: var(--text-secondary);
    cursor: not-allowed;
}

/* CONTAINER PRINCIPAL */
.caixa-container {
    display: flex;
    gap: 0;
    height: calc(100vh - 45px);
    padding: 0;
    margin: 0;
    width: 100%;
    overflow: hidden;
}

.caixa-main {
    padding: 0.8rem;
    overflow: hidden;
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 45px);
}

/* MODAL COMBO */
.modal-combo {
    width: 900px !important;
    max-width: 90vw !important;
    max-height: 85vh !important;
    overflow: hidden;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0 !important;
}

@media (max-width: 768px) {
    .modal-combo {
        width: 95vw !important;
        max-height: 90vh !important;
    }
}

.modal-combo h2 {
    padding: 0.6rem 1.2rem;
    margin: 0;
    background: transparent;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    font-size: 1.1rem;
    flex-shrink: 0;
}

.modal-combo-container {
    flex: 1;
    overflow: hidden;
    padding: 1.5rem;
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
}

@media (max-width: 968px) {
    .modal-combo-container {
        grid-template-columns: 1fr;
        overflow-y: auto;
    }
}

.combo-coluna-esquerda {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    padding: 1.5rem;
    background: var(--bg-header);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    height: fit-content;
}

.combo-coluna-direita {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow: hidden;
}

.combo-section-title {
    color: var(--text-primary);
    font-size: 1.05rem;
    font-weight: 600;
    margin: 0;
}

.combo-info-box {
    padding: 1rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-top: 0.5rem;
}
    flex-direction: column;
}

.slots-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 1rem;
}

.slots-header h3 {
    font-size: 1.05rem;
    color: var(--text-primary);
    margin: 0;
}

.btn-small {
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
}

.slots-lista {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
    flex: 1;
    padding-right: 0.5rem;
}

.slots-lista::-webkit-scrollbar {
    width: 6px;
}

.slots-lista::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 3px;
}

.slots-lista::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 3px;
}

.empty-slots-message {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
    background: var(--bg-primary);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
}

.empty-slots-message p {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.empty-slots-message small {
    font-size: 0.85rem;
}

.slot-card {
    background: var(--bg-header);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.2rem;
}

.slot-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 0.8rem;
}

.slot-card-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-icon {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.btn-icon-small {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.5rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    min-width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
}

.btn-icon-small:hover {
    background: var(--btn-primary);
    border-color: var(--btn-primary);
    color: var(--bg-primary);
    transform: translateY(-1px);
}

.btn-icon-small.btn-danger {
    color: var(--text-secondary);
}

.btn-icon-small.btn-danger:hover {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-icon:hover, .btn-icon-small:hover {
    border-color: var(--btn-primary);
    color: var(--btn-primary);
}

.btn-icon.btn-danger:hover {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
}

/* Emoji Picker para Slots */
.emoji-picker-slot {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.3rem;
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 0.6rem;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.3rem;
    max-height: 200px;
    overflow-y: auto;
    width: 320px;
}

.emoji-picker-slot button {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.4rem;
    font-size: 1.3rem;
    cursor: pointer;
    transition: all 0.2s;
}

.emoji-picker-slot button:hover {
    background: var(--btn-primary);
    border-color: var(--btn-primary);
    transform: scale(1.1);
}

.slot-itens-lista {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.slot-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.8rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
}

.slot-item-produto {
    flex: 1;
    min-width: 0;
}

.slot-item-produto strong {
    display: block;
    color: var(--text-primary);
    font-size: 0.95rem;
    margin-bottom: 0.2rem;
}

.slot-item-quantidade {
    text-align: center;
    padding: 0 0.8rem;
    border-left: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
}

.slot-item-remove {
    flex-shrink: 0;
}

.slot-item-remove .btn-icon {
    min-width: 38px;
    height: 38px;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-header);
}
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.slot-item-produto {
    flex: 2;
}

.slot-item-quantidade {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.slot-item-remove {
    flex-shrink: 0;
}

.modal-combo-footer {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.5rem;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    background: var(--bg-header);
}

.modal-combo-footer .btn-secondary,
.modal-combo-footer .btn-primary {
    min-width: 120px;
    padding: 0.7rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 500;
}

/* MODAL SELE√á√ÉO COMBO (PDV) */
.modal-selecao-combo {
    width: 700px !important;
    max-width: 90vw !important;
    max-height: 85vh !important;
    overflow: hidden;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0 !important;
}

@media (max-width: 768px) {
    .modal-selecao-combo {
        width: 95vw !important;
        max-height: 90vh !important;
    }
}

.modal-selecao-combo h2 {
    padding: 0.6rem 1.2rem;
    margin: 0;
    background: transparent;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    font-size: 1.1rem;
    flex-shrink: 0;
}

.modal-selecao-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.selecao-info {
    background: var(--bg-header);
    padding: 1.2rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.selecao-nome {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
}

.selecao-preco {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--btn-primary);
}

.selecao-slots-lista {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
}

.selecao-slot-card {
    background: var(--bg-header);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.2rem;
}

.selecao-slot-header {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.selecao-slot-header::before {
    content: 'üìã';
    font-size: 1.2rem;
}

.selecao-slot-opcoes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.8rem;
}

.selecao-opcao-card {
    background: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.selecao-opcao-card:hover {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.05);
}

.selecao-opcao-card.selected {
    border-color: var(--btn-primary);
    background: rgba(244, 162, 58, 0.15);
    box-shadow: 0 0 0 2px rgba(244, 162, 58, 0.2);
}

.selecao-opcao-card.sem-estoque {
    opacity: 0.5;
    cursor: not-allowed;
    border-color: #666;
}

.selecao-opcao-card.sem-estoque:hover {
    border-color: #666;
    background: var(--bg-primary);
}

.selecao-opcao-nome {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
}

.selecao-opcao-estoque {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.selecao-opcao-estoque.estoque-insuficiente {
    color: #ff6b6b;
    font-weight: 600;
}

.selecao-opcao-check {
    display: none;
    color: var(--btn-primary);
    font-size: 1.2rem;
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
}

.selecao-opcao-card.selected .selecao-opcao-check {
    display: block;
}

.selecao-opcao-card {
    position: relative;
}

.modal-selecao-footer {
    display: flex;
    gap: 0.8rem;
    padding: 1rem 1.5rem;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    background: var(--bg-header);
}

/* TABS */
.tabs-menu {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
}

.tab-btn {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.8rem 1.5rem;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    color: var(--text-primary);
    border-color: var(--btn-primary);
}

.tab-btn.active {
    background: var(--btn-primary);
    color: var(--btn-text);
    border-color: var(--btn-primary);
}

.tab-content {
    display: none;
    flex: 1;
    overflow: hidden;
}

.tab-content.active {
    display: flex;
    flex-direction: column;
}

/* TABELAS */
.data-table {
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.data-table th {
    background: var(--bg-header);
    color: var(--text-primary);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.data-table tr:hover {
    background: var(--bg-primary);
}

/* TOGGLE SWITCH */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: 0.4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--btn-primary);
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* SIDEBAR PEDIDOS ATIVOS */
.pedidos-ativos-sidebar {
    background: var(--bg-header);
    border-left: 1px solid var(--border-color);
    height: calc(100vh - 80px);
    overflow-y: auto;
}

/* T√≠tulo fixo do sidebar */
.sidebar-titulo {
    position: sticky;
    top: 0;
    background: var(--bg-header);
    z-index: 10;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.titulo-icon {
    font-size: 1.3rem;
}

.titulo-texto {
    flex: 1;
}

.titulo-contador {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

/* Estat√≠sticas fixas do Sidebar */
.sidebar-stats {
    position: sticky;
    top: 60px;
    display: flex;
    justify-content: space-around;
    gap: 0.3rem;
    padding: 0.6rem 0.8rem;
    background: var(--bg-header);
    border-bottom: 1px solid var(--border-color);
    z-index: 9;
}

.sidebar-stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.4rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.sidebar-stat span:first-child {
    font-size: 0.85rem;
}

.sidebar-stat span:last-child {
    font-size: 0.8rem;
    font-weight: 700;
}

.sidebar-stat.pendente span:last-child { color: #6c757d; }
.sidebar-stat.preparando span:last-child { color: #F4A23A; }
.sidebar-stat.pronto span:last-child { color: #4CAF50; }
.sidebar-stat.tempo span:last-child { color: #F4A23A; }
.pedido-card-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.pedido-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.8rem;
}

.pedido-senha {
    background: var(--btn-primary);
    color: var(--btn-text);
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-weight: bold;
}

.pedido-hora {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.pedido-cliente-nome {
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.8rem;
}

.pedido-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.info-label {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.info-valor {
    color: var(--btn-primary);
    font-weight: bold;
}

.pedido-status-badge {
    text-align: center;
    padding: 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.8rem;
}

.status-pendente {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.status-preparando {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}

.status-pronto {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.pedido-acoes-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.btn-sidebar-action {
    padding: 0.6rem;
    border: 1px solid var(--border-color);
    background: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.btn-sidebar-action:hover {
    background: var(--btn-primary);
    border-color: var(--btn-primary);
}

.btn-action {
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: var(--btn-hover);
}


.btn-table-action:hover {
    border-color: var(--btn-primary);
    color: var(--btn-primary);
}

.page-title {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
}

.filtros-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    color: var(--btn-primary);
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 1rem;
}

.empty-message {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}

/* MODAL */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    background-color: var(--bg-card);
    margin: 10% auto;
    padding: 2rem;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 400px;
    text-align: center;
}

.modal-close {
    color: var(--text-secondary);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.modal-close:hover {
    color: var(--text-primary);
}

/* LINKS GRID - OTIMIZADO E RESPONSIVO */
.links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.2rem;
}

.link-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.link-card:hover {
    border-color: var(--btn-primary);
    transform: translateY(-2px);
}

.link-icon {
    font-size: 2.5rem;
    line-height: 1;
}

.link-card h3 {
    color: var(--text-primary);
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.link-card p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.85rem;
    line-height: 1.4;
}

.link-url {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.url-input {
    flex: 1;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.5rem 0.7rem;
    border-radius: 6px;
    font-size: 0.8rem;
    min-width: 0;
}

.btn-copy {
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    padding: 0.5rem 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.btn-copy:hover {
    background: var(--btn-hover);
    transform: scale(1.05);
}

/* Responsividade para Links */
@media (max-width: 768px) {
    .links-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .link-card {
        padding: 1.2rem;
    }
    
    .link-icon {
        font-size: 2rem;
    }
    
    .link-card h3 {
        font-size: 1rem;
    }
    
    .url-input {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
}

@media (min-width: 1400px) {
    .links-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* BADGES DE TIPO E STATUS */
.tipo-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.tipo-admin {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.tipo-caixa {
    background: rgba(244, 162, 58, 0.2);
    color: var(--btn-primary);
}

.tipo-cozinha {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}

.tipo-gerente {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.status-badge-user {
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-ativo {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.status-inativo {
    background: rgba(108, 117, 125, 0.2);
    color: #6c757d;
}

/* RESPONSIVO */
@media (max-width: 1400px) {
    .novo-pedido-layout {
        flex-direction: column;
    }
    
    .produtos-cardapio-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
}

@media (max-width: 1024px) {
    .caixa-container {
        grid-template-columns: 1fr;
    }
    
    .pedidos-ativos-sidebar {
        display: none;
    }
    
    .novo-pedido-layout {
        flex-direction: column;
        height: auto;
    }
    
    .pedido-form-section {
        max-height: none;
        width: 100%;
        max-width: 100%;
    }
}

/* CONFIGURA√á√ïES */
.config-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.config-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
}

.config-section-header {
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 1rem;
}

.config-section-header h3 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 1.2rem;
}

.config-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0;
}

.config-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.config-preview {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.preview-header {
    background: var(--bg-header);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    display: inline-block;
}

.preview-header span {
    color: var(--text-primary);
    font-size: 1.3rem;
    font-weight: 600;
}

#config-nome-sistema {
    max-width: 500px;
}

#config-emoji-sistema {
    text-align: center;
    font-size: 1.5rem;
}


.caixa-container {
    display: flex;
    gap: 0;
    height: calc(100vh - 45px);
    padding: 0;
    margin: 0;
    width: 100%;
    overflow: hidden;
}

.caixa-main {
    padding: 1.5rem;
    overflow-y: auto;
}

/* TABS */
.tabs-menu {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
}

.tab-btn {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.8rem 1.5rem;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    color: var(--text-primary);
    border-color: var(--btn-primary);
}

.tab-btn.active {
    background: var(--btn-primary);
    color: var(--btn-text);
    border-color: var(--btn-primary);
}

.tab-content {
    display: none;
    flex: 1;
    overflow: hidden;
}

.tab-content.active {
    display: flex;
    flex-direction: column;
}

/* FORMUL√ÅRIOS */
.pedido-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.form-section, .carrinho-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.form-label {
    color: var(--text-primary);
    font-weight: normal;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control {
    background: var(--bg-primary) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
    padding: 0.75rem;
    border-radius: 8px;
    width: 100%;
}

.form-control:focus {
    border-color: var(--btn-primary) !important;
    outline: none;
}

.produtos-disponiveis {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 1rem;
}

.produto-item-list {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.produto-item-list:hover {
    border-color: var(--btn-primary);
    background: var(--bg-card);
}

.produto-preco-list {
    color: var(--btn-primary);
    font-weight: 600;
}

.section-title {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.lista-itens-carrinho {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.total-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg-primary);
    border: 2px solid var(--btn-primary);
    border-radius: 8px;
    margin: 1rem 0;
}

.total-label {
    font-size: 1.1rem;
    color: var(--btn-primary);
    font-weight: normal;
}

.total-valor {
    font-size: 1.1rem;
    color: var(--btn-primary);
    font-weight: normal;
}

.btn-finalizar-pedido {
    width: 100%;
    padding: 1rem;
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-finalizar-pedido:hover {
    background: var(--btn-hover);
}

/* TABELAS */
.data-table {
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.data-table th {
    background: var(--bg-header);
    color: var(--text-primary);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.data-table tr:hover {
    background: var(--bg-primary);
}

/* TOGGLE SWITCH */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: 0.4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--btn-primary);
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* SIDEBAR PEDIDOS ATIVOS */
.pedidos-ativos-sidebar {
    background: var(--bg-header);
    border-left: 1px solid var(--border-color);
    height: calc(100vh - 80px);
    overflow-y: auto;
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--bg-header);
    z-index: 10;
}

.sidebar-header h3 {
    color: var(--text-primary);
    margin: 0;
    font-size: 1.1rem;
}

.badge-count {
    background: var(--btn-primary);
    color: var(--btn-text);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
}

.pedidos-lista {
    padding: 1rem;
}

.pedido-card-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.pedido-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.8rem;
}

.pedido-senha {
    background: var(--btn-primary);
    color: var(--btn-text);
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-weight: bold;
}

.pedido-hora {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.pedido-cliente-nome {
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.8rem;
}

.pedido-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.info-label {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.info-valor {
    color: var(--btn-primary);
    font-weight: bold;
}

.pedido-status-badge {
    text-align: center;
    padding: 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.8rem;
}

.status-pendente {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.status-preparando {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}

.status-pronto {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.pedido-acoes-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.btn-sidebar-action {
    padding: 0.6rem;
    border: 1px solid var(--border-color);
    background: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.btn-sidebar-action:hover {
    background: var(--btn-primary);
    border-color: var(--btn-primary);
}

.btn-action {
    background: var(--btn-primary);
    color: var(--btn-text);
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: var(--btn-hover);
}


.btn-table-action:hover {
    border-color: var(--btn-primary);
    color: var(--btn-primary);
}

.page-title {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
}

.filtros-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    color: var(--btn-primary);
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 1rem;
}

.empty-message {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}

/* MODAL */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    background-color: var(--bg-card);
    margin: 10% auto;
    padding: 2rem;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 400px;
    text-align: center;
}

.modal-close {
    color: var(--text-secondary);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.modal-close:hover {
    color: var(--text-primary);
}

/* LINKS GRID */

/* BADGES DE TIPO E STATUS */
.tipo-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.tipo-admin {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.tipo-caixa {
    background: rgba(244, 162, 58, 0.2);
    color: var(--btn-primary);
}

.tipo-cozinha {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}

.tipo-gerente {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.status-badge-user {
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-ativo {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.status-inativo {
    background: rgba(108, 117, 125, 0.2);
    color: #6c757d;
}

/* BARRA DE ROLAGEM PARA TABELA DO CARD√ÅPIO COM CABE√áALHO FIXO */
.table-wrapper-fixed-header {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg-card);
}

.data-table-header {
    margin: 0;
    border: none;
    border-bottom: 2px solid var(--border-color);
}

.data-table-header thead {
    background: var(--bg-header);
}

.data-table-header th {
    background: var(--bg-header);
    border-bottom: none;
}

.table-scroll-container {
    max-height: calc(100vh - 330px);
    overflow-y: auto;
    overflow-x: visible;
    background: var(--bg-card);
}

.table-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
    background: #e89530;
}

.table-scroll-container .data-table {
    margin: 0;
    border: none;
    overflow: visible;
}

.table-scroll-container .data-table tbody {
    overflow: visible;
}

.table-scroll-container .data-table tr {
    overflow: visible;
}

.table-scroll-container .data-table thead {
    display: none;
}

/* Garantir que as colunas tenham a mesma largura */
.data-table-header,
.table-scroll-container .data-table {
    table-layout: fixed;
    width: 100%;
}

.data-table-header th:nth-child(1),
.table-scroll-container .data-table td:nth-child(1) {
    width: 30%;
    text-align: left;
    padding-left: 1.5rem;
}

.data-table-header th:nth-child(2),
.table-scroll-container .data-table td:nth-child(2) {
    width: 20%;
    text-align: center;
}

.data-table-header th:nth-child(3),
.table-scroll-container .data-table td:nth-child(3) {
    width: 25%;
    text-align: center;
}

.data-table-header th:nth-child(4),
.table-scroll-container .data-table td:nth-child(4) {
    width: 25%;
    text-align: center;
}

/* Larguras espec√≠ficas para tabela de Estoque */
#tabela-estoque td:nth-child(1),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(1) {
    width: 10%;
    text-align: center;
}

#tabela-estoque td:nth-child(2),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(2) {
    width: 25%;
    text-align: left;
    padding-left: 1.5rem;
}

#tabela-estoque td:nth-child(3),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(3) {
    width: 20%;
    text-align: center;
}

#tabela-estoque td:nth-child(4),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(4) {
    width: 15%;
    text-align: center;
}

#tabela-estoque td:nth-child(5),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(5) {
    width: 15%;
    text-align: center;
}

#tabela-estoque td:nth-child(6),
.table-wrapper-fixed-header:has(#tabela-estoque) .data-table-header th:nth-child(6) {
    width: 15%;
    text-align: center;
}

/* ========== RELAT√ìRIOS - NOVOS ESTILOS ========== */
.relatorios-filtros {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.2rem;
    margin-bottom: 1.5rem;
}

.filtros-rapidos {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
}

.btn-filtro-rapido {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-filtro-rapido:hover {
    border-color: var(--btn-primary);
    color: var(--btn-primary);
}

.btn-filtro-rapido.active {
    background: var(--btn-primary);
    color: var(--btn-text);
    border-color: var(--btn-primary);
}

.filtros-personalizados {
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    margin-top: 1rem;
}

.stats-grid-relatorios {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card-relatorio {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    font-size: 2.5rem;
    line-height: 1;
}

.stat-info {
    flex: 1;
}

.stat-card-relatorio .stat-value {
    font-size: 1.8rem;
    color: var(--btn-primary);
    font-weight: 700;
    margin-bottom: 0.3rem;
}

.stat-card-relatorio .stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.dashboard-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.2rem;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid var(--border-color);
}

.section-header h3 {
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
}

.section-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-expandir {
    background: var(--bg-primary);
    color: var(--btn-primary);
    border: 1px solid var(--btn-primary);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-expandir:hover {
    background: var(--btn-primary);
    color: var(--btn-text);
}

.top-itens-container {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.top-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.top-item-posicao {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--btn-primary);
    min-width: 40px;
    text-align: center;
}

.top-item-info {
    flex: 1;
}

.top-item-nome {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.3rem;
}

.top-item-quantidade {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.top-item-valor {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--btn-primary);
    text-align: right;
}

.historico-vendas {
    margin-top: 1rem;
}

.table-wrapper-historico {
    width: 100%;
}

.table-scroll-container-historico {
    max-height: 450px;
    min-height: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.table-scroll-container-historico::-webkit-scrollbar {
    width: 10px;
}

.table-scroll-container-historico::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

.table-scroll-container-historico::-webkit-scrollbar-thumb {
    background: var(--btn-primary);
    border-radius: 4px;
}

.table-scroll-container-historico::-webkit-scrollbar-thumb:hover {
    background: var(--btn-hover);
}

.table-scroll-container-historico .data-table {
    margin: 0;
}

.table-scroll-container-historico .data-table tbody tr td {
    padding: 1rem;
}

.loading-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .stats-grid-relatorios {
        grid-template-columns: 1fr;
    }
    
    .filtros-rapidos {
        flex-direction: column;
    }
    
    .btn-filtro-rapido {
        width: 100%;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/caixa.js"></script>
<script>
// Fun√ß√£o showTab - Troca de abas sem reload (mant√©m fullscreen)
function showTab(tabName) {
    // Esconder todas as abas
    const allTabs = document.querySelectorAll('.tab-content');
    allTabs.forEach(tab => tab.classList.remove('active'));
    
    // Remover classe active de todos os bot√µes
    const allButtons = document.querySelectorAll('.tab-btn');
    allButtons.forEach(btn => btn.classList.remove('active'));
    
    // Mostrar aba selecionada
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Ativar bot√£o correspondente
    const selectedButton = document.querySelector(`.tab-btn[onclick*="${tabName}"]`);
    if (selectedButton) {
        selectedButton.classList.add('active');
    }
    
    // Atualizar URL sem reload (History API)
    const urls = {
        'novo-pedido': '{% url "caixa_novo_pedido" %}',
        'cardapio': '{% url "caixa_cardapio_dia" %}',
        'estoque': '{% url "caixa_estoque" %}',
        'relatorios': '{% url "caixa_relatorios" %}',
        'links': '{% url "caixa_links" %}',
        'usuarios': '{% url "caixa_usuarios" %}',
        'configuracoes': '{% url "caixa_configuracoes" %}'
    };
    
    if (urls[tabName]) {
        history.pushState({tab: tabName}, '', urls[tabName]);
    }
}

// Lidar com navega√ß√£o do navegador (bot√µes voltar/avan√ßar)
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.tab) {
        showTab(event.state.tab);
    }
});

// Registrar estado inicial
if (history.state === null) {
    const currentTab = document.querySelector('.tab-content.active');
    if (currentTab) {
        const tabName = currentTab.id.replace('tab-', '');
        history.replaceState({tab: tabName}, '', window.location.href);
    }
}

function mostrarQRCode(qrCode) {
    const modal = document.getElementById('modal-qrcode');
    const container = document.getElementById('qrcode-container');
    const urlElement = document.getElementById('qrcode-url');
    const url = window.location.origin + '/acompanhamento/' + qrCode + '/';
    
    // Limpar container anterior
    container.innerHTML = '';
    
    // Gerar QR Code
    new QRCode(container, {
        text: url,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });
    
    // Mostrar URL
    urlElement.textContent = url;
    urlElement.style.marginTop = '1rem';
    urlElement.style.fontSize = '0.9rem';
    urlElement.style.wordBreak = 'break-all';
    
    // Mostrar modal com prote√ß√£o contra fechamento autom√°tico
    modal.style.display = 'block';
    modal.setAttribute('data-manual-open', 'true');
    
    // Sincronizar com tela do cliente via localStorage
    localStorage.setItem('qrcode_modal', JSON.stringify({
        action: 'open',
        qrCode: qrCode,
        url: url,
        timestamp: Date.now()
    }));
    
    // Log para debug
    console.log('Modal QR Code aberto:', qrCode);
    
    // Prevenir qualquer tentativa de fechar o modal automaticamente
    setTimeout(() => {
        if (modal.style.display === 'none' && modal.getAttribute('data-manual-open') === 'true') {
            console.warn('Modal foi fechado automaticamente! Reabrindo...');
            modal.style.display = 'block';
        }
    }, 100);
}

function fecharModal() {
    const modal = document.getElementById('modal-qrcode');
    
    // Marcar que o fechamento √© manual
    modal.setAttribute('data-manual-open', 'false');
    modal.style.display = 'none';
    
    // Sincronizar fechamento com tela do cliente via localStorage
    localStorage.setItem('qrcode_modal', JSON.stringify({
        action: 'close',
        timestamp: Date.now()
    }));
    
    // Log para debug
    console.log('Modal QR Code fechado pelo usu√°rio');
    
    // Atualizar apenas a sidebar de pedidos ativos sem recarregar a p√°gina
    atualizarPedidosAtivos();
}

async function atualizarPedidosAtivos() {
    try {
        const response = await fetch('/caixa/api/pedidos-ativos/');
        const data = await response.json();
        
        if (data.success) {
            renderizarPedidosAtivos(data.pedidos);
            
            // Atualizar estat√≠sticas do sidebar
            if (data.estatisticas) {
                const elemPendente = document.getElementById('sidebar-stat-pendente');
                const elemPreparando = document.getElementById('sidebar-stat-preparando');
                const elemPronto = document.getElementById('sidebar-stat-pronto');
                const elemTempo = document.getElementById('sidebar-stat-tempo');
                
                if (elemPendente) elemPendente.textContent = data.estatisticas.total_pendente || 0;
                if (elemPreparando) elemPreparando.textContent = data.estatisticas.total_preparando || 0;
                if (elemPronto) elemPronto.textContent = data.estatisticas.total_pronto || 0;
                
                // Tempo m√©dio
                if (elemTempo) {
                    if (data.estatisticas.tempo_medio_segundos && data.estatisticas.tempo_medio_segundos > 0) {
                        const min = Math.floor(data.estatisticas.tempo_medio_segundos / 60);
                        const seg = data.estatisticas.tempo_medio_segundos % 60;
                        elemTempo.textContent = `${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
                    } else {
                        elemTempo.textContent = '--:--';
                    }
                }
            }
        }
    } catch (error) {
        console.error('Erro ao atualizar pedidos:', error);
    }
}

function renderizarPedidosAtivos(pedidos) {
    const container = document.querySelector('.pedidos-lista');
    const contador = document.querySelector('.titulo-contador');
    
    if (!container) return;
    
    // Atualizar contador
    if (contador) {
        contador.textContent = `(${pedidos.length})`;
    }
    
    // Obter IDs dos pedidos atuais na API
    const pedidosIds = pedidos.map(p => p.id);
    
    // Remover cards de pedidos que n√£o existem mais na API
    const cardsExistentes = container.querySelectorAll('.pedido-card-simples');
    cardsExistentes.forEach(card => {
        const select = card.querySelector('select[data-pedido-id]');
        if (select) {
            const pedidoId = parseInt(select.dataset.pedidoId);
            if (!pedidosIds.includes(pedidoId)) {
                // Pedido n√£o existe mais, remover com anima√ß√£o
                card.style.transition = 'opacity 0.3s';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 300);
            }
        }
    });
    
    // Atualizar ou criar cards
    pedidos.forEach((pedido, index) => {
        const selectElement = container.querySelector(`select[data-pedido-id="${pedido.id}"]`);
        
        if (selectElement) {
            // Card existe, apenas atualizar cron√¥metro
            const card = selectElement.closest('.pedido-card-simples');
            if (!card) return;
            
            const cronometroTempo = card.querySelector('.cronometro-tempo');
            if (cronometroTempo) {
                atualizarCronometro(cronometroTempo, pedido);
            }
        } else {
            // Card n√£o existe, criar novo
            const novoCard = criarCardPedido(pedido);
            
            // Inserir na posi√ß√£o correta (ordenado por criado_em)
            const cards = Array.from(container.querySelectorAll('.pedido-card-simples'));
            let inserido = false;
            
            for (let i = 0; i < cards.length; i++) {
                const cardSelect = cards[i].querySelector('select[data-pedido-id]');
                if (cardSelect) {
                    const cardId = parseInt(cardSelect.dataset.pedidoId);
                    const cardPedido = pedidos.find(p => p.id === cardId);
                    if (cardPedido && new Date(pedido.criado_em) < new Date(cardPedido.criado_em)) {
                        container.insertBefore(novoCard, cards[i]);
                        inserido = true;
                        break;
                    }
                }
            }
            
            if (!inserido) {
                container.appendChild(novoCard);
            }
            
            // Anima√ß√£o de entrada
            novoCard.style.opacity = '0';
            setTimeout(() => {
                novoCard.style.transition = 'opacity 0.3s';
                novoCard.style.opacity = '1';
            }, 10);
        }
    });
    
    // Se n√£o h√° pedidos, mostrar mensagem
    if (pedidos.length === 0 && container.querySelectorAll('.pedido-card-simples').length === 0) {
        container.innerHTML = '<p class="empty-message">Nenhum pedido ativo</p>';
    }
}

function atualizarCronometro(cronometroTempo, pedido) {
    let segundos = 0;
    if (pedido.tempo_decorrido) {
        segundos = pedido.tempo_decorrido;
    } else if (pedido.criado_em) {
        const criado = new Date(pedido.criado_em);
        const agora = new Date();
        segundos = Math.floor((agora - criado) / 1000);
    }
    
    if (segundos < 0) {
        cronometroTempo.textContent = '--:--';
        return;
    }
    
    const horas = Math.floor(segundos / 3600);
    const min = Math.floor((segundos % 3600) / 60);
    const seg = segundos % 60;
    
    if (horas > 0) {
        cronometroTempo.textContent = `${String(horas).padStart(2, '0')}:${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
    } else {
        cronometroTempo.textContent = `${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
    }
    
    const cronometroContainer = cronometroTempo.closest('.pedido-cronometro');
    if (cronometroContainer) {
        const minutosTotais = Math.floor(segundos / 60);
        if (minutosTotais >= 15) {
            cronometroContainer.style.color = '#ff4444';
        } else if (minutosTotais >= 10) {
            cronometroContainer.style.color = '#F4A23A';
        } else {
            cronometroContainer.style.color = '#BDBDBD';
        }
    }
}

function criarCardPedido(pedido) {
    const card = document.createElement('div');
    card.className = 'pedido-card-simples';
    
    // Itens HTML
    let itensHTML = '';
    if (pedido.itens && pedido.itens.length > 0) {
        pedido.itens.forEach(item => {
            itensHTML += `
                <div class="pedido-item-linha">
                    <span class="item-descricao">${item.quantidade}x ${item.produto_nome}</span>
                    <span class="item-valor">R$ ${item.subtotal}</span>
                </div>
            `;
            
            // Se for combo, adicionar escolhas
            if (item.is_combo && item.escolhas && item.escolhas.length > 0) {
                item.escolhas.forEach(escolha => {
                    itensHTML += `
                        <div class="pedido-item-linha" style="margin-left: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                            <span class="item-descricao">‚Ä¢ ${escolha.produto_nome}</span>
                        </div>
                    `;
                });
            }
        });
    }
    
    card.innerHTML = `
        <div class="pedido-cabecalho">
            <span class="pedido-nome-cliente">${pedido.cliente_nome || 'Cliente'}</span>
            <span class="pedido-cronometro">
                <span class="cronometro-icon">‚è±Ô∏è</span>
                <span class="cronometro-tempo">00:00</span>
            </span>
        </div>
        
        <div class="pedido-meta-info">
            <span>#${pedido.numero_pedido}</span>
            <span class="pedido-meta-separador">‚Ä¢</span>
            <span>${pedido.tipo_display}</span>
            <span class="pedido-meta-separador">‚Ä¢</span>
            <span>üí≥ ${pedido.forma_pagamento}</span>
        </div>
        
        <div class="pedido-itens-lista">
            ${itensHTML}
            <div class="pedido-item-linha pedido-total-linha">
                <span class="item-descricao">üí∞ Total:</span>
                <span class="item-valor-total">R$ ${pedido.total}</span>
            </div>
        </div>
        
        <div class="pedido-acoes-linha">
            <select class="pedido-status-select-inline" data-pedido-id="${pedido.id}" onchange="alterarStatusPedido(this)">
                <option value="pendente" ${pedido.status === 'pendente' ? 'selected' : ''}>‚è≥ Fila</option>
                <option value="preparando" ${pedido.status === 'preparando' ? 'selected' : ''}>üë®‚Äçüç≥ Em preparo</option>
                <option value="pronto" ${pedido.status === 'pronto' ? 'selected' : ''}>‚úÖ Pronto</option>
                <option value="entregue" ${pedido.status === 'entregue' ? 'selected' : ''}>üéâ Entregue</option>
            </select>
            
            <button class="btn-acao-quadrado btn-qr" onclick="mostrarQRCode('${pedido.qr_code || ''}')">
                <span class="btn-icon-grande">üì±</span>
            </button>
            
            <button class="btn-acao-quadrado btn-editar" onclick="abrirModalEditar(${pedido.id})">
                <span class="btn-icon-grande">‚úèÔ∏è</span>
            </button>
            
            <button class="btn-acao-quadrado btn-cancelar" onclick="abrirModalExcluirPedido(${pedido.id})">
                <span class="btn-icon-grande">üóëÔ∏è</span>
            </button>
        </div>
    `;
    
    // Aplicar cor ao select
    const select = card.querySelector('.pedido-status-select-inline');
    const cores = {
        'pendente': '#6c757d',
        'preparando': '#F4A23A',
        'pronto': '#28a745',
        'entregue': '#6c757d'
    };
    const coresTexto = {
        'pendente': '#fff',
        'preparando': '#000',
        'pronto': '#fff',
        'entregue': '#fff'
    };
    select.style.backgroundColor = cores[pedido.status] || '#6c757d';
    select.style.color = coresTexto[pedido.status] || '#fff';
    
    // Atualizar cron√¥metro inicial
    const cronometroTempo = card.querySelector('.cronometro-tempo');
    if (cronometroTempo) {
        atualizarCronometro(cronometroTempo, pedido);
    }
    
    return card;
}

// Iniciar polling de pedidos ativos
let intervalPedidosAtivos = null;
let intervalCronometrosLocal = null;

function iniciarPollingPedidos() {
    // Atualizar imediatamente
    atualizarPedidosAtivos();
    
    // Atualizar dados da API a cada 1 segundo (mais r√°pido para sincroniza√ß√£o)
    if (intervalPedidosAtivos) {
        clearInterval(intervalPedidosAtivos);
    }
    intervalPedidosAtivos = setInterval(atualizarPedidosAtivos, 1000);
    
    // Atualizar cron√¥metros localmente a cada 1 segundo
    if (intervalCronometrosLocal) {
        clearInterval(intervalCronometrosLocal);
    }
    intervalCronometrosLocal = setInterval(atualizarCronometrosLocal, 1000);
}

function atualizarCronometrosLocal() {
    const container = document.querySelector('.pedidos-lista');
    if (!container) return;
    
    const cards = container.querySelectorAll('.pedido-card-simples');
    cards.forEach(card => {
        const cronometroTempo = card.querySelector('.cronometro-tempo');
        const cronometroContainer = card.querySelector('.pedido-cronometro');
        
        if (!cronometroTempo || !cronometroContainer) return;
        
        // Pegar o data-criado do cronometro container (se existir)
        // ou calcular baseado no tempo atual mostrado
        const textoAtual = cronometroTempo.textContent;
        if (textoAtual === '--:--' || textoAtual === '00:00') return;
        
        // Incrementar 1 segundo no tempo atual
        const partes = textoAtual.split(':');
        let segundos = 0;
        
        if (partes.length === 3) {
            // HH:MM:SS
            segundos = parseInt(partes[0]) * 3600 + parseInt(partes[1]) * 60 + parseInt(partes[2]);
        } else if (partes.length === 2) {
            // MM:SS
            segundos = parseInt(partes[0]) * 60 + parseInt(partes[1]);
        }
        
        segundos++; // Incrementar 1 segundo
        
        // Formatar novamente
        const horas = Math.floor(segundos / 3600);
        const min = Math.floor((segundos % 3600) / 60);
        const seg = segundos % 60;
        
        if (horas > 0) {
            cronometroTempo.textContent = `${String(horas).padStart(2, '0')}:${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
        } else {
            cronometroTempo.textContent = `${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
        }
        
        // Atualizar cor
        const minutosTotais = Math.floor(segundos / 60);
        if (minutosTotais >= 15) {
            cronometroContainer.style.color = '#ff4444';
        } else if (minutosTotais >= 10) {
            cronometroContainer.style.color = '#F4A23A';
        } else {
            cronometroContainer.style.color = '#BDBDBD';
        }
    });
}

// Iniciar polling quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando polling de pedidos ativos');
    
    // Inicializar tempo m√©dio com valor do backend
    const tempoMedioSegundos = {{ estatisticas.tempo_medio_segundos|default:0 }};
    if (tempoMedioSegundos > 0) {
        const min = Math.floor(tempoMedioSegundos / 60);
        const seg = tempoMedioSegundos % 60;
        document.getElementById('sidebar-stat-tempo').textContent = `${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
    }
    
    iniciarPollingPedidos();
    
    // Listener para sincroniza√ß√£o entre abas (cozinha <-> caixa)
    let ultimoTimestampVerificado = Date.now();
    console.log('üîß Iniciando sincroniza√ß√£o entre abas. Timestamp inicial:', ultimoTimestampVerificado);
    console.log('üì¶ localStorage atual:', localStorage.getItem('pedido_status_changed'));

    // M√©todo 1: BroadcastChannel (mais moderno e confi√°vel)
    if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('pedido_updates');
        channel.onmessage = function(event) {
            console.log('üì° Mensagem recebida via BroadcastChannel:', event.data);
            ultimoTimestampVerificado = event.data.timestamp;
            atualizarPedidosAtivos();
        };
        console.log('‚úÖ BroadcastChannel configurado');
    } else {
        console.warn('‚ö†Ô∏è BroadcastChannel n√£o suportado neste navegador');
    }

    // M√©todo 2: Storage event (backup para navegadores antigos)
    window.addEventListener('storage', function(e) {
        console.log('üì° Evento storage disparado:', e.key, e.newValue);
        if (e.key === 'pedido_status_changed') {
            console.log('‚úÖ Evento storage - Mudan√ßa de status detectada');
            atualizarPedidosAtivos();
        }
    });

    // M√©todo 3: Polling do localStorage (fallback final) - 500ms para resposta mais r√°pida
    const intervalSync = setInterval(function() {
        try {
            const statusChange = localStorage.getItem('pedido_status_changed');
            if (statusChange) {
                const data = JSON.parse(statusChange);
                if (data.timestamp > ultimoTimestampVerificado) {
                    console.log('‚úÖ Nova mudan√ßa detectada via polling!', data);
                    console.log('   Timestamp anterior:', ultimoTimestampVerificado);
                    console.log('   Timestamp novo:', data.timestamp);
                    ultimoTimestampVerificado = data.timestamp;
                    atualizarPedidosAtivos();
                }
            }
        } catch (error) {
            console.error('Erro ao verificar mudan√ßas de status:', error);
        }
    }, 500);
    
    console.log('‚úÖ Sincroniza√ß√£o configurada. Interval ID:', intervalSync);
});

// ========== FUN√á√ïES DO MODAL DE EXCLUIR PEDIDO ==========

let pedidoIdParaExcluir = null;

function abrirModalExcluirPedido(pedidoId) {
    pedidoIdParaExcluir = pedidoId;
    const modal = document.getElementById('modal-excluir-pedido');
    const input = document.getElementById('confirmar-exclusao-input');
    const btnConfirmar = document.getElementById('btn-confirmar-exclusao');
    
    // Limpar campo e desabilitar bot√£o
    input.value = '';
    btnConfirmar.disabled = true;
    btnConfirmar.style.opacity = '0.5';
    btnConfirmar.style.cursor = 'not-allowed';
    
    modal.style.display = 'block';
    
    // Focar no input ap√≥s um pequeno delay
    setTimeout(() => input.focus(), 100);
}

function fecharModalExcluirPedido() {
    const modal = document.getElementById('modal-excluir-pedido');
    modal.style.display = 'none';
    pedidoIdParaExcluir = null;
}

function validarCampoExclusao() {
    const input = document.getElementById('confirmar-exclusao-input');
    const btnConfirmar = document.getElementById('btn-confirmar-exclusao');
    const valorDigitado = input.value.trim().toUpperCase();
    
    if (valorDigitado === 'EXCLUIR') {
        btnConfirmar.disabled = false;
        btnConfirmar.style.opacity = '1';
        btnConfirmar.style.cursor = 'pointer';
    } else {
        btnConfirmar.disabled = true;
        btnConfirmar.style.opacity = '0.5';
        btnConfirmar.style.cursor = 'not-allowed';
    }
}

// Adicionar listener para Enter no campo de confirma√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    const inputExclusao = document.getElementById('confirmar-exclusao-input');
    if (inputExclusao) {
        inputExclusao.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const btnConfirmar = document.getElementById('btn-confirmar-exclusao');
                if (!btnConfirmar.disabled) {
                    confirmarExclusaoPedido();
                }
            }
        });
    }
});


// Fun√ß√£o para mostrar toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

async function confirmarExclusaoPedido() {
    const modal = document.getElementById('modal-excluir-pedido');
    const tipo = modal.dataset.tipo || 'pedido';
    
    if (tipo === 'item') {
        // Excluir item (produto)
        const produtoId = modal.dataset.produtoId;
        if (!produtoId) {
            showToast('‚ùå Erro: ID do item n√£o encontrado', 'error');
            return;
        }
        
        const btnConfirmar = document.getElementById('btn-confirmar-exclusao');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = '‚è≥ Excluindo...';
        
        try {
            const response = await fetch(`/caixa/produto/${produtoId}/excluir/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('‚úÖ Item exclu√≠do com sucesso!', 'success');
                fecharModalExcluirPedido();
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('‚ùå ' + (data.error || 'Erro desconhecido'), 'error');
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'üóëÔ∏è Excluir Item';
            }
        } catch (error) {
            console.error('Erro ao excluir item:', error);
            showToast('‚ùå Erro ao excluir item! Verifique sua conex√£o.', 'error');
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'üóëÔ∏è Excluir Item';
        }
    } else {
        // Excluir pedido (c√≥digo original)
        if (!pedidoIdParaExcluir) {
            showToast('‚ùå Erro: ID do pedido n√£o encontrado', 'error');
            return;
        }
        
        const btnConfirmar = document.getElementById('btn-confirmar-exclusao');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = '‚è≥ Excluindo...';
        
        try {
            const response = await fetch('/caixa/excluir-pedido/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `pedido_id=${pedidoIdParaExcluir}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('‚úÖ ' + data.message, 'success');
                fecharModalExcluirPedido();
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('‚ùå ' + (data.error || 'Erro desconhecido'), 'error');
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'üóëÔ∏è Excluir Pedido';
            }
        } catch (error) {
            console.error('Erro ao excluir pedido:', error);
            showToast('‚ùå Erro ao excluir pedido! Verifique sua conex√£o.', 'error');
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'üóëÔ∏è Excluir Pedido';
        }
    }
}

function fecharModalSeForaDoConteudo(event) {
    // Fechar modal ao clicar no fundo escuro (fora do conte√∫do)
    const modalId = event.target.id;
    
    if (modalId === 'modal-qrcode') {
        fecharModal();
    } else if (modalId === 'modal-editar-pedido') {
        fecharModalEditar();
    } else if (modalId === 'modal-produto') {
        fecharModalProduto();
    } else if (modalId === 'modal-categorias') {
        fecharModalCategorias();
    } else if (modalId === 'modal-combo') {
        fecharModalCombo();
    } else if (modalId === 'modal-selecao-combo') {
        fecharModalSelecaoCombo();
    } else if (modalId === 'modal-excluir-pedido') {
        fecharModalExcluirPedido();
    } else if (modalId === 'modal-editar-usuario') {
        fecharModalEditarUsuario();
    }
}

function copiarURL(btn) {
    const input = btn.previousElementSibling;
    input.select();
    document.execCommand('copy');
    
    const originalText = btn.textContent;
    btn.textContent = '‚úì';
    btn.style.background = '#28a745';
    
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

// CONFIGURA√á√ïES - Preview do nome do sistema
document.addEventListener('DOMContentLoaded', function() {
    const nomeInput = document.getElementById('config-nome-sistema');
    const emojiInput = document.getElementById('config-emoji-sistema');
    const preview = document.getElementById('preview-nome');
    
    if (nomeInput && emojiInput && preview) {
        function atualizarPreview() {
            const nome = nomeInput.value || 'Cantina System';
            const emoji = emojiInput.value || 'üçΩÔ∏è';
            preview.textContent = emoji + ' ' + nome;
        }
        
        nomeInput.addEventListener('input', atualizarPreview);
        emojiInput.addEventListener('input', atualizarPreview);
    }
    
    // CRON√îMETROS DOS PEDIDOS
    iniciarCronometros();
    
    // CORES DOS SELECTS DE STATUS
    atualizarCoresStatus();
    
    // CARREGAR CATEGORIAS AO INICIAR
    carregarCategorias();
    
    // OCULTAR PRODUTOS INATIVOS NO GRID
    ocultarProdutosInativos();
    
    // RESTAURAR ESTADO DOS TOGGLES "MOSTRAR ESTOQUE"
    restaurarEstadoMostrarEstoque();
    
    // BUSCA DE PRODUTOS NA ABA CARD√ÅPIO
    const buscaCardapio = document.getElementById('busca-cardapio-caixa');
    if (buscaCardapio) {
        buscaCardapio.addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase().trim();
            const linhas = document.querySelectorAll('#tabela-cardapio tbody tr');
            
            linhas.forEach(linha => {
                const nomeProduto = linha.getAttribute('data-produto-nome');
                
                if (nomeProduto.includes(termo)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        });
    }
    
    // MONITORAR MODAL QR CODE
    const modal = document.getElementById('modal-qrcode');
    if (modal) {
        // Observar mudan√ßas no estilo do modal
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const display = modal.style.display;
                    if (display === 'none') {
                        console.log('AVISO: Modal foi fechado! Stack trace:', new Error().stack);
                    }
                }
            });
        });
        
        observer.observe(modal, {
            attributes: true,
            attributeFilter: ['style']
        });
    }
});

function atualizarCoresStatus() {
    const selects = document.querySelectorAll('.pedido-status-select-inline');
    const cores = {
        'pendente': '#6c757d',
        'preparando': '#F4A23A',
        'pronto': '#28a745',
        'entregue': '#6c757d'
    };
    
    const coresTexto = {
        'pendente': '#fff',
        'preparando': '#000',
        'pronto': '#fff',
        'entregue': '#fff'
    };
    
    selects.forEach(select => {
        const status = select.value;
        select.style.backgroundColor = cores[status] || '#6c757d';
        select.style.color = coresTexto[status] || '#fff';
    });
}

function iniciarCronometros() {
    // REMOVIDO: Cron√¥metros agora s√£o atualizados apenas via polling da API
    // Isso evita conflitos e valores incorretos
    console.log('Cron√¥metros ser√£o atualizados via polling da API');
}

async function alterarStatusPedido(selectElement) {
    const pedidoId = selectElement.dataset.pedidoId;
    const novoStatus = selectElement.value;
    
    try {
        const response = await fetch('/caixa/alterar-status-pedido/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                pedido_id: pedidoId,
                status: novoStatus
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Notificar outras abas sobre a mudan√ßa usando m√∫ltiplos m√©todos
            const changeData = {
                pedido_id: pedidoId,
                novo_status: novoStatus,
                timestamp: Date.now()
            };
            
            console.log('üîî Salvando mudan√ßa no localStorage:', changeData);
            
            // M√©todo 1: localStorage
            localStorage.setItem('pedido_status_changed', JSON.stringify(changeData));
            
            // M√©todo 2: BroadcastChannel
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('pedido_updates');
                channel.postMessage(changeData);
                console.log('üì° Mensagem enviada via BroadcastChannel');
                channel.close();
            }
            
            // Atualizar cor do select baseado no status
            const cores = {
                'pendente': '#6c757d',
                'preparando': '#F4A23A',
                'pronto': '#28a745',
                'entregue': '#6c757d'
            };
            
            const coresTexto = {
                'pendente': '#fff',
                'preparando': '#000',
                'pronto': '#fff',
                'entregue': '#fff'
            };
            
            selectElement.style.backgroundColor = cores[novoStatus];
            selectElement.style.color = coresTexto[novoStatus];
            
            // Se entregue, remover o card ap√≥s 2 segundos
            if (novoStatus === 'entregue') {
                setTimeout(() => {
                    selectElement.closest('.pedido-card-simples').style.transition = 'opacity 0.5s';
                    selectElement.closest('.pedido-card-simples').style.opacity = '0';
                    setTimeout(() => {
                        selectElement.closest('.pedido-card-simples').remove();
                    }, 500);
                }, 2000);
            }
        } else {
            showToast('Erro ao alterar status: ' + (result.error || 'Erro desconhecido'));
            // Reverter sele√ß√£o
            location.reload();
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao alterar status do pedido!', 'error');
        location.reload();
    }
}

async function salvarNomeSistema() {
    const nome = document.getElementById('config-nome-sistema').value.trim();
    const emoji = document.getElementById('config-emoji-sistema').value.trim();
    
    if (!nome) {
        showToast('Por favor, informe um nome para o sistema!', 'info');
        return;
    }
    
    try {
        const response = await fetch('/caixa/salvar-configuracoes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                nome_sistema: nome,
                emoji_sistema: emoji
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Configura√ß√µes salvas com sucesso!', 'success');
            // Atualizar o logo no header
            document.querySelector('.logo').textContent = (emoji || 'üçΩÔ∏è') + ' ' + nome;
        } else {
            showToast('Erro ao salvar configura√ß√µes: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar configura√ß√µes!', 'error');
    }
}

function limparSelecaoCardapio() {
    // Seleciona todos os checkboxes da coluna "Dispon√≠vel Hoje" (terceira coluna)
    const checkboxesDisponiveis = document.querySelectorAll('#tabela-cardapio tbody tr td:nth-child(3) input[type="checkbox"]');
    const checkboxesMostrarEstoque = document.querySelectorAll('#tabela-cardapio tbody tr td:nth-child(4) input[type="checkbox"]');
    
    // Desmarcar "Dispon√≠vel Hoje"
    checkboxesDisponiveis.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            // Disparar o evento de mudan√ßa para salvar no backend
            atualizarDisponibilidade(checkbox);
        }
    });
    
    // Desmarcar "Mostrar Estoque"
    checkboxesMostrarEstoque.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            // Disparar o evento de mudan√ßa
            toggleMostrarEstoque(checkbox);
        }
    });
    
    // Atualizar contador de itens dispon√≠veis
    atualizarContadorDisponiveis();
    
    // Feedback visual
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚úì Limpo';
    btn.style.background = '#28a745';
    
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

async function atualizarDisponibilidade(checkbox) {
    const produtoId = checkbox.dataset.produtoId;
    const disponivel = checkbox.checked;
    
    try {
        const response = await fetch('/caixa/atualizar-disponibilidade/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                produto_id: produtoId,
                disponivel: disponivel
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Atualizar a lista de produtos dispon√≠veis na aba "Novo Pedido"
            const produtoCard = document.querySelector(`.produto-card-cardapio[data-codigo="${produtoId}"]`);
            if (produtoCard) {
                if (disponivel) {
                    produtoCard.style.display = '';
                } else {
                    produtoCard.style.display = 'none';
                }
            }
            // Atualizar contador de itens dispon√≠veis
            atualizarContadorDisponiveis();
        } else {
            showToast('Erro ao atualizar disponibilidade: ' + (result.error || 'Erro desconhecido'));
            // Reverter checkbox
            checkbox.checked = !disponivel;
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao atualizar disponibilidade!', 'error');
        // Reverter checkbox
        checkbox.checked = !disponivel;
    }
}

function ocultarProdutosInativos() {
    // Verificar quais produtos est√£o marcados como dispon√≠veis (terceira coluna)
    const checkboxes = document.querySelectorAll('#tabela-cardapio tbody tr td:nth-child(3) input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        const produtoId = checkbox.dataset.produtoId;
        const disponivel = checkbox.checked;
        const produtoCard = document.querySelector(`.produto-card-cardapio[data-codigo="${produtoId}"]`);
        
        if (produtoCard && !disponivel) {
            produtoCard.style.display = 'none';
        }
    });
    
    // Atualizar contador
    atualizarContadorDisponiveis();
}

function atualizarContadorDisponiveis() {
    const checkboxes = document.querySelectorAll('#tabela-cardapio tbody tr td:nth-child(3) input[type="checkbox"]');
    let total = 0;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            total++;
        }
    });
    
    const contadorElement = document.getElementById('total-disponiveis');
    if (contadorElement) {
        contadorElement.textContent = total;
    }
}

function toggleMostrarEstoque(checkbox) {
    const produtoId = checkbox.dataset.produtoId;
    const mostrar = checkbox.checked;
    
    // Se est√° habilitando "Mostrar Estoque", marcar automaticamente "Dispon√≠vel Hoje"
    if (mostrar) {
        const row = checkbox.closest('tr');
        const checkboxDisponivel = row.querySelector('td:nth-child(3) input[type="checkbox"]');
        
        if (checkboxDisponivel && !checkboxDisponivel.checked) {
            checkboxDisponivel.checked = true;
            // Disparar a atualiza√ß√£o de disponibilidade
            atualizarDisponibilidade(checkboxDisponivel);
        }
    }
    
    // Salvar estado no localStorage
    localStorage.setItem(`mostrar_estoque_${produtoId}`, mostrar);
    
    // Encontrar o badge de estoque correspondente na aba "Novo Pedido"
    const badge = document.querySelector(`.produto-badge-estoque[data-produto-id="${produtoId}"]`);
    
    if (badge) {
        badge.style.display = mostrar ? 'block' : 'none';
    }
}

function restaurarEstadoMostrarEstoque() {
    // Restaurar estado dos toggles "Mostrar Estoque" do localStorage
    const toggles = document.querySelectorAll('#tabela-cardapio tbody tr td:nth-child(4) input[type="checkbox"]');
    
    toggles.forEach(toggle => {
        const produtoId = toggle.dataset.produtoId;
        const estadoSalvo = localStorage.getItem(`mostrar_estoque_${produtoId}`);
        
        if (estadoSalvo === 'true') {
            toggle.checked = true;
            
            // Mostrar o badge correspondente na aba "Novo Pedido"
            const badge = document.querySelector(`.produto-badge-estoque[data-produto-id="${produtoId}"]`);
            if (badge) {
                badge.style.display = 'block';
            }
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// VARI√ÅVEIS GLOBAIS PARA EDI√á√ÉO
let pedidoEmEdicao = null;
let itensEdicao = [];

// ABRIR MODAL DE EDI√á√ÉO
async function abrirModalEditar(pedidoId) {
    try {
        // Buscar dados do pedido
        const response = await fetch(`/caixa/pedido/${pedidoId}/`);
        const pedido = await response.json();
        
        if (!pedido.success) {
            showToast('Erro ao carregar pedido!', 'error');
            return;
        }
        
        pedidoEmEdicao = pedido.data;
        itensEdicao = pedido.data.itens.map(item => ({
            produto_id: item.produto_id,
            nome: item.produto_nome,
            preco: parseFloat(item.preco_unitario),
            quantidade: item.quantidade,
            observacoes: item.observacoes || ''
        }));
        
        // Preencher formul√°rio
        document.getElementById('edit-cliente-nome').value = pedido.data.cliente_nome || '';
        document.getElementById('edit-tipo-pedido').value = pedido.data.tipo || 'balcao';
        document.getElementById('edit-forma-pagamento').value = pedido.data.forma_pagamento || '';
        document.getElementById('edit-observacoes').value = pedido.data.observacoes || '';
        
        // Atualizar lista de itens
        atualizarListaItensEdicao();
        
        // Mostrar modal
        document.getElementById('modal-editar-pedido').style.display = 'block';
        
        // Configurar busca de produtos
        configurarBuscaProdutosEdicao();
        
    } catch (error) {
        console.error('Erro ao abrir modal de edi√ß√£o:', error);
        showToast('Erro ao carregar dados do pedido!', 'error');
    }
}

// FECHAR MODAL DE EDI√á√ÉO
function fecharModalEditar() {
    document.getElementById('modal-editar-pedido').style.display = 'none';
    pedidoEmEdicao = null;
    itensEdicao = [];
}

// ADICIONAR PRODUTO NA EDI√á√ÉO
function adicionarProdutoEdicao(id, nome, preco) {
    const itemExistente = itensEdicao.find(item => item.produto_id === id);
    
    if (itemExistente) {
        itemExistente.quantidade++;
    } else {
        itensEdicao.push({
            produto_id: id,
            nome: nome,
            preco: parseFloat(preco),
            quantidade: 1,
            observacoes: ''
        });
    }
    
    atualizarListaItensEdicao();
}

// REMOVER PRODUTO DA EDI√á√ÉO
function removerProdutoEdicao(index) {
    itensEdicao.splice(index, 1);
    atualizarListaItensEdicao();
}

// ALTERAR QUANTIDADE NA EDI√á√ÉO
function alterarQuantidadeEdicao(index, delta) {
    itensEdicao[index].quantidade += delta;
    if (itensEdicao[index].quantidade <= 0) {
        removerProdutoEdicao(index);
    } else {
        atualizarListaItensEdicao();
    }
}

// ATUALIZAR LISTA DE ITENS NA EDI√á√ÉO
function atualizarListaItensEdicao() {
    const listaItens = document.getElementById('edit-itens-lista');
    const totalElement = document.getElementById('edit-total-pedido');
    
    if (itensEdicao.length === 0) {
        listaItens.innerHTML = `
            <div style="text-align: center; padding: 2rem 1rem; color: var(--text-secondary);">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;">üõí</div>
                <p style="margin: 0.5rem 0; font-size: 0.9rem; font-weight: 500;">Carrinho vazio</p>
                <small style="font-size: 0.8rem; opacity: 0.7;">Clique nos produtos para adicionar</small>
            </div>
        `;
        totalElement.textContent = '0.00';
        return;
    }
    
    let html = '';
    let total = 0;
    
    itensEdicao.forEach((item, index) => {
        const subtotal = item.preco * item.quantidade;
        total += subtotal;
        
        html += `
            <div class="edit-item-linha">
                <div class="edit-item-info">
                    <div class="edit-item-nome">${item.nome}</div>
                    <div class="edit-item-detalhes">R$ ${item.preco.toFixed(2)} cada</div>
                </div>
                <div class="edit-item-acoes">
                    <div class="edit-item-acoes-qty">
                        <button onclick="alterarQuantidadeEdicao(${index}, -1)" class="btn-qty">-</button>
                        <span class="item-quantidade">${item.quantidade}</span>
                        <button onclick="alterarQuantidadeEdicao(${index}, 1)" class="btn-qty">+</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: var(--btn-primary); font-weight: bold; font-size: 0.9rem;">R$ ${subtotal.toFixed(2)}</span>
                        <button onclick="removerProdutoEdicao(${index})" class="btn-remove">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    listaItens.innerHTML = html;
    totalElement.textContent = total.toFixed(2);
}

// CONFIGURAR BUSCA DE PRODUTOS NA EDI√á√ÉO
function configurarBuscaProdutosEdicao() {
    const buscaInput = document.getElementById('edit-busca-item');
    if (!buscaInput) return;
    
    buscaInput.value = '';
    
    // Remover listeners antigos
    const novoInput = buscaInput.cloneNode(true);
    buscaInput.parentNode.replaceChild(novoInput, buscaInput);
    
    // Adicionar novo listener
    novoInput.addEventListener('input', function(e) {
        const termo = e.target.value.toLowerCase();
        const produtos = document.querySelectorAll('.edit-produto-card');
        
        produtos.forEach(produto => {
            const nome = produto.dataset.nome || '';
            const codigo = produto.dataset.codigo || '';
            
            if (nome.includes(termo) || codigo.includes(termo)) {
                produto.style.display = 'flex';
            } else {
                produto.style.display = 'none';
            }
        });
    });
}

// SALVAR EDI√á√ÉO DO PEDIDO
async function salvarEdicaoPedido() {
    // Valida√ß√£o 1: Verificar se h√° itens no carrinho
    if (itensEdicao.length === 0) {
        showToast('‚ùå Adicione pelo menos um item ao pedido!', 'error');
        return;
    }
    
    // Valida√ß√£o 2: Verificar nome do cliente
    const clienteNome = document.getElementById('edit-cliente-nome').value.trim();
    if (!clienteNome) {
        showToast('‚ùå Por favor, informe o nome do cliente!', 'error');
        document.getElementById('edit-cliente-nome').focus();
        return;
    }
    
    // Valida√ß√£o 3: Verificar forma de pagamento
    const formaPagamento = document.getElementById('edit-forma-pagamento').value;
    if (!formaPagamento) {
        showToast('‚ùå Por favor, selecione uma forma de pagamento!', 'error');
        document.getElementById('edit-forma-pagamento').focus();
        return;
    }
    
    const dados = {
        pedido_id: pedidoEmEdicao.id,
        tipo: document.getElementById('edit-tipo-pedido').value,
        cliente_nome: clienteNome,
        forma_pagamento: formaPagamento,
        observacoes: document.getElementById('edit-observacoes').value,
        itens: itensEdicao
    };
    
    try {
        const response = await fetch('/caixa/editar-pedido/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Pedido atualizado com sucesso!', 'success');
            fecharModalEditar();
            location.reload();
        } else {
            showToast('‚ùå Erro ao atualizar pedido: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao atualizar pedido! Verifique sua conex√£o.', 'error');
    }
}

// ========== FUN√á√ïES DE FILTRO DE ESTOQUE ==========

function filtrarEstoque() {
    const pesquisa = document.getElementById('pesquisa-estoque').value.toLowerCase();
    const categoria = document.getElementById('filtro-categoria-estoque').value;
    const linhas = document.querySelectorAll('#tabela-estoque tbody tr');
    
    let visiveisCount = 0;
    
    linhas.forEach(linha => {
        const nome = linha.getAttribute('data-nome') || '';
        const codigo = linha.getAttribute('data-codigo') || '';
        const categoriaItem = linha.getAttribute('data-categoria') || '';
        
        // Verificar se corresponde √† pesquisa
        const correspondePesquisa = nome.includes(pesquisa) || codigo.includes(pesquisa);
        
        // Verificar se corresponde √† categoria
        const correspondeCategoria = !categoria || categoriaItem === categoria;
        
        // Mostrar/ocultar linha
        if (correspondePesquisa && correspondeCategoria) {
            linha.style.display = '';
            visiveisCount++;
        } else {
            linha.style.display = 'none';
        }
    });
    
    // Feedback visual se n√£o houver resultados
    const tbody = document.querySelector('#tabela-estoque tbody');
    let mensagemVazia = tbody.querySelector('.mensagem-sem-resultados');
    
    if (visiveisCount === 0) {
        if (!mensagemVazia) {
            mensagemVazia = document.createElement('tr');
            mensagemVazia.className = 'mensagem-sem-resultados';
            mensagemVazia.innerHTML = '<td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Nenhum item encontrado</td>';
            tbody.appendChild(mensagemVazia);
        }
    } else {
        if (mensagemVazia) {
            mensagemVazia.remove();
        }
    }
}

function limparFiltrosEstoque() {
    document.getElementById('pesquisa-estoque').value = '';
    document.getElementById('filtro-categoria-estoque').value = '';
    filtrarEstoque();
}

// ========== FUN√á√ïES DO MODAL DE CATEGORIAS ==========

let categoriasData = [];

async function abrirModalCategorias() {
    const modal = document.getElementById('modal-categorias');
    modal.style.display = 'block';
    await carregarCategorias();
}

function fecharModalCategorias() {
    const modal = document.getElementById('modal-categorias');
    modal.style.display = 'none';
    document.getElementById('nova-categoria-nome').value = '';
    document.getElementById('nova-categoria-emoji').value = 'üçΩÔ∏è';
    document.getElementById('emoji-selector').style.display = 'none';
}

function abrirSeletorEmoji() {
    const selector = document.getElementById('emoji-selector');
    const isOpening = selector.style.display === 'none';
    selector.style.display = isOpening ? 'block' : 'none';
    
    // Destacar emoji atual quando abrir
    if (isOpening) {
        const emojiAtual = document.getElementById('nova-categoria-emoji').value;
        destacarEmojiSelecionado(emojiAtual);
    }
}

function selecionarEmoji(emoji) {
    document.getElementById('nova-categoria-emoji').value = emoji;
    document.getElementById('emoji-selector').style.display = 'none';
}

function destacarEmojiSelecionado(emojiAtual) {
    // Remover destaque anterior
    document.querySelectorAll('.emoji-btn').forEach(btn => {
        btn.classList.remove('emoji-selected');
    });
    
    // Adicionar destaque ao emoji atual
    document.querySelectorAll('.emoji-btn').forEach(btn => {
        if (btn.textContent.trim() === emojiAtual) {
            btn.classList.add('emoji-selected');
        }
    });
}

async function carregarCategorias() {
    try {
        const response = await fetch('/caixa/categorias/listar/');
        const data = await response.json();
        
        if (data.success) {
            categoriasData = data.categorias;
            renderizarCategorias();
            popularCamposCategoria();
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

function popularCamposCategoria() {
    // Popular select de categoria no modal de produto
    const selectProdutoCategoria = document.getElementById('produto-categoria');
    if (selectProdutoCategoria) {
        const valorAtual = selectProdutoCategoria.value;
        selectProdutoCategoria.innerHTML = '<option value="">Selecione uma categoria...</option>';
        categoriasData.forEach(cat => {
            // Filtrar categoria "Combo" (is_sistema) do select de novo produto
            if (cat.is_sistema) return;
            
            const option = document.createElement('option');
            option.value = cat.nome;
            option.textContent = `${cat.emoji || 'üìÇ'} ${cat.nome}`;
            selectProdutoCategoria.appendChild(option);
        });
        // Restaurar valor selecionado se existir
        if (valorAtual) {
            selectProdutoCategoria.value = valorAtual;
        }
    }
    
    // Popular filtro de categoria na aba estoque
    const filtroCategoria = document.getElementById('filtro-categoria-estoque');
    if (filtroCategoria) {
        const valorAtual = filtroCategoria.value;
        filtroCategoria.innerHTML = '<option value="">üìÇ Todas as Categorias</option>';
        categoriasData.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.nome;
            option.textContent = `${cat.emoji || 'üìÇ'} ${cat.nome}`;
            filtroCategoria.appendChild(option);
        });
        // Restaurar valor selecionado se existir
        if (valorAtual) {
            filtroCategoria.value = valorAtual;
        }
    }
}

function renderizarCategorias() {
    const lista = document.getElementById('lista-categorias');
    
    if (categoriasData.length === 0) {
        lista.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhuma categoria cadastrada</p>';
        return;
    }
    
    // Ordenar: categorias do sistema (Combo) primeiro, depois as outras por nome
    const categoriasOrdenadas = [...categoriasData].sort((a, b) => {
        if (a.is_sistema && !b.is_sistema) return -1;
        if (!a.is_sistema && b.is_sistema) return 1;
        return a.nome.localeCompare(b.nome);
    });
    
    lista.innerHTML = categoriasOrdenadas.map(cat => {
        const isSistema = cat.is_sistema || false;
        const emojiClick = isSistema ? '' : 'onclick="editarEmojiCategoria(' + cat.id + ')"';
        const emojiStyle = isSistema ? 'cursor: default;' : '';
        const sistemaLabel = isSistema ? ' <span style="font-size: 0.75rem; color: var(--text-secondary);">(Autom√°tico)</span>' : '';
        
        // N√£o renderizar bot√µes para categorias do sistema
        const botoesAcoes = isSistema ? '' : `
            <div class="categoria-acoes">
                <button onclick="toggleEditarCategoria(${cat.id})" class="btn-table-action btn-editar-categoria" id="btn-edit-${cat.id}" style="background: #3498db;">Editar</button>
                <button onclick="excluirCategoria(${cat.id})" class="btn-table-action" style="background: #e74c3c;">Excluir</button>
            </div>
        `;
        
        return `
        <div class="categoria-item ${isSistema ? 'categoria-sistema' : ''}" id="categoria-${cat.id}">
            <div class="categoria-emoji" id="emoji-${cat.id}" ${emojiClick} style="${emojiStyle}">${cat.emoji || 'üìÇ'}</div>
            <div class="categoria-nome-container" style="flex: 1;">
                <div class="categoria-nome" id="nome-${cat.id}">${cat.nome}${sistemaLabel}</div>
                <input type="text" class="categoria-nome-input" id="input-nome-${cat.id}" value="${cat.nome}" style="display: none;" ${isSistema ? 'disabled' : ''}>
            </div>
            ${botoesAcoes}
        </div>
        `;
    }).join('');
}

let categoriaEditandoId = null;
let emojiSelectorAberto = null;

function toggleEditarCategoria(categoriaId) {
    const nomeDiv = document.getElementById(`nome-${categoriaId}`);
    const nomeInput = document.getElementById(`input-nome-${categoriaId}`);
    const btnEdit = document.getElementById(`btn-edit-${categoriaId}`);
    
    // Se est√° editando, salvar
    if (categoriaEditandoId === categoriaId) {
        salvarEdicaoCategoria(categoriaId);
    } else {
        // Cancelar edi√ß√£o anterior se houver
        if (categoriaEditandoId !== null) {
            cancelarEdicaoCategoria(categoriaEditandoId);
        }
        
        // Iniciar edi√ß√£o
        categoriaEditandoId = categoriaId;
        nomeDiv.style.display = 'none';
        nomeInput.style.display = 'block';
        nomeInput.focus();
        btnEdit.textContent = 'Salvar';
        btnEdit.style.background = '#27ae60';
    }
}

function cancelarEdicaoCategoria(categoriaId) {
    const nomeDiv = document.getElementById(`nome-${categoriaId}`);
    const nomeInput = document.getElementById(`input-nome-${categoriaId}`);
    const btnEdit = document.getElementById(`btn-edit-${categoriaId}`);
    
    nomeDiv.style.display = 'block';
    nomeInput.style.display = 'none';
    btnEdit.textContent = 'Editar';
    btnEdit.style.background = '#3498db';
    categoriaEditandoId = null;
}

async function salvarEdicaoCategoria(categoriaId) {
    const nomeInput = document.getElementById(`input-nome-${categoriaId}`);
    const novoNome = nomeInput.value.trim();
    
    if (!novoNome) {
        showToast('O nome da categoria n√£o pode estar vazio!', 'error');
        return;
    }
    
    // Fechar seletor de emojis se estiver aberto
    if (emojiSelectorAberto) {
        const selector = document.getElementById(`emoji-selector-${emojiSelectorAberto}`);
        if (selector) selector.remove();
        emojiSelectorAberto = null;
    }
    
    try {
        const response = await fetch(`/caixa/categorias/${categoriaId}/editar/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ nome: novoNome })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Atualizar dados locais
            const categoria = categoriasData.find(c => c.id === categoriaId);
            if (categoria) {
                categoria.nome = novoNome;
            }
            
            // Atualizar visualiza√ß√£o
            const nomeDiv = document.getElementById(`nome-${categoriaId}`);
            nomeDiv.textContent = novoNome;
            
            // Atualizar campos de categoria em outros lugares
            popularCamposCategoria();
            
            cancelarEdicaoCategoria(categoriaId);
        } else {
            showToast('Erro ao editar categoria: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao editar categoria!', 'error');
    }
}

function editarEmojiCategoria(categoriaId) {
    if (categoriaEditandoId !== categoriaId) {
        return; // S√≥ permite editar emoji se estiver no modo de edi√ß√£o
    }
    
    // Fechar seletor anterior se houver
    if (emojiSelectorAberto && emojiSelectorAberto !== categoriaId) {
        const selectorAnterior = document.getElementById(`emoji-selector-${emojiSelectorAberto}`);
        if (selectorAnterior) selectorAnterior.remove();
    }
    
    // Verificar se j√° existe seletor
    const selectorExistente = document.getElementById(`emoji-selector-${categoriaId}`);
    if (selectorExistente) {
        selectorExistente.remove();
        emojiSelectorAberto = null;
        return;
    }
    
    // Criar seletor de emoji inline
    const categoriaItem = document.getElementById(`categoria-${categoriaId}`);
    const emojiSelector = document.createElement('div');
    emojiSelector.id = `emoji-selector-${categoriaId}`;
    emojiSelector.className = 'emoji-selector-inline';
    emojiSelector.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 0.3rem; max-height: 120px; overflow-y: auto; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; margin-top: 0.5rem;">
            ${['üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•û', 'üßá', 'üßÄ', 'üçó', 'ü•©', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü´î', 'ü•ô', 'üßÜ', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'üç§', 'üç®', 'üç¶', 'üßÅ', 'üç∞', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'ü•ó', 'ü•ò', 'ü´ï', '‚òï', 'üçµ', 'ü´ñ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üçπ'].map(emoji => 
                `<button class="emoji-btn-small" onclick="selecionarEmojiCategoria(${categoriaId}, '${emoji}')" style="padding: 0.3rem; font-size: 1.2rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">${emoji}</button>`
            ).join('')}
        </div>
    `;
    
    categoriaItem.appendChild(emojiSelector);
    emojiSelectorAberto = categoriaId;
}

async function selecionarEmojiCategoria(categoriaId, emoji) {
    try {
        const response = await fetch(`/caixa/categorias/${categoriaId}/editar/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ emoji: emoji })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Atualizar dados locais
            const categoria = categoriasData.find(c => c.id === categoriaId);
            if (categoria) {
                categoria.emoji = emoji;
            }
            
            // Atualizar visualiza√ß√£o
            const emojiDiv = document.getElementById(`emoji-${categoriaId}`);
            emojiDiv.textContent = emoji;
            
            // Atualizar campos de categoria em outros lugares
            popularCamposCategoria();
            
            // Fechar seletor
            const selector = document.getElementById(`emoji-selector-${categoriaId}`);
            if (selector) selector.remove();
            emojiSelectorAberto = null;
        } else {
            showToast('Erro ao atualizar emoji: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao atualizar emoji!', 'error');
    }
}

async function salvarNovaCategoria() {
    const nome = document.getElementById('nova-categoria-nome').value.trim();
    const emoji = document.getElementById('nova-categoria-emoji').value;
    
    if (!nome) {
        showToast('Por favor, informe o nome da categoria!', 'info');
        return;
    }
    
    try {
        const response = await fetch('/caixa/categorias/criar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ nome, emoji })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('nova-categoria-nome').value = '';
            document.getElementById('nova-categoria-emoji').value = 'üçΩÔ∏è';
            await carregarCategorias();
        } else {
            showToast('Erro ao criar categoria: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao criar categoria!', 'error');
    }
}

async function excluirCategoria(categoriaId) {
    if (!confirm('Tem certeza que deseja excluir esta categoria?')) {
        return;
    }
    
    try {
        const response = await fetch(`/caixa/categorias/${categoriaId}/excluir/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            await carregarCategorias();
        } else {
            showToast('Erro ao excluir categoria: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao excluir categoria!', 'error');
    }
}

// ========== FUN√á√ïES DO MENU DE A√á√ïES ==========

function toggleMenuAcoes(event, produtoId) {
    event.stopPropagation();
    
    // Fechar todos os outros menus
    document.querySelectorAll('.menu-acoes-dropdown').forEach(menu => {
        if (menu.id !== `menu-acoes-${produtoId}`) {
            menu.style.display = 'none';
        }
    });
    
    // Toggle do menu clicado
    const menu = document.getElementById(`menu-acoes-${produtoId}`);
    const isVisible = menu.style.display === 'block';
    
    if (isVisible) {
        menu.style.display = 'none';
    } else {
        // Verificar se o menu deve abrir para cima ou para baixo
        const button = event.target;
        const buttonRect = button.getBoundingClientRect();
        const menuHeight = 150; // altura aproximada do menu
        const spaceBelow = window.innerHeight - buttonRect.bottom;
        
        // Se n√£o h√° espa√ßo suficiente embaixo, abrir para cima
        if (spaceBelow < menuHeight) {
            menu.style.top = 'auto';
            menu.style.bottom = '100%';
            menu.style.marginTop = '0';
            menu.style.marginBottom = '0.3rem';
        } else {
            menu.style.top = '100%';
            menu.style.bottom = 'auto';
            menu.style.marginTop = '0.3rem';
            menu.style.marginBottom = '0';
        }
        
        menu.style.display = 'block';
    }
}

// Fechar menus ao clicar fora
document.addEventListener('click', function() {
    document.querySelectorAll('.menu-acoes-dropdown').forEach(menu => {
        menu.style.display = 'none';
    });
});

async function toggleAtivarItem(produtoId, estaAtivo) {
    const acao = estaAtivo ? 'inativar' : 'ativar';
    const mensagem = estaAtivo ? 
        'Tem certeza que deseja inativar este item? Ele ser√° removido do card√°pio.' : 
        'Deseja ativar este item novamente?';
    
    if (!confirm(mensagem)) return;
    
    try {
        const response = await fetch(`/caixa/produto/${produtoId}/toggle-ativo/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`‚úÖ Item ${acao === 'inativar' ? 'inativado' : 'ativado'} com sucesso!`, 'success');
            location.reload();
        } else {
            showToast('‚ùå Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao alterar status do item!', 'error');
    }
}

function abrirModalExcluirItem(produtoId, produtoNome) {
    const modal = document.getElementById('modal-excluir-pedido');
    const titulo = modal.querySelector('h2');
    const mensagem = modal.querySelector('p');
    
    titulo.textContent = 'üóëÔ∏è Excluir Item';
    mensagem.innerHTML = `Tem certeza que deseja excluir <strong>${produtoNome}</strong>?<br><br>Digite <strong>EXCLUIR</strong> para confirmar:`;
    
    // Armazenar o ID do produto para usar na confirma√ß√£o
    modal.dataset.produtoId = produtoId;
    modal.dataset.tipo = 'item';
    
    modal.style.display = 'block';
}

// ========== FUN√á√ÉO PARA EDITAR ITEM (PRODUTO OU COMBO) ==========

async function editarItem(produtoId) {
    try {
        // Buscar informa√ß√µes do produto para verificar se √© combo
        const response = await fetch(`/caixa/produto/${produtoId}/`);
        const data = await response.json();
        
        if (data.success) {
            const produto = data.produto;
            
            // Verificar se o produto tem categoria "Combo" (categoria do sistema)
            const isCombo = produto.categoria_nome === 'Combo';
            
            if (isCombo) {
                // Abrir modal de combo
                await abrirModalCombo(produtoId);
            } else {
                // Abrir modal de produto normal
                abrirModalProduto(produtoId);
            }
        } else {
            showToast('‚ùå Erro ao carregar item: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao editar item:', error);
        showToast('‚ùå Erro ao carregar item! Verifique sua conex√£o.', 'error');
    }
}

// ========== FUN√á√ïES DO MODAL DE PRODUTO ==========

function abrirModalProduto(produtoId = null) {
    const modal = document.getElementById('modal-produto');
    const titulo = document.getElementById('modal-produto-titulo');
    const btnSalvar = document.getElementById('btn-salvar-produto');
    
    // Garantir que as categorias estejam carregadas
    if (categoriasData.length === 0) {
        carregarCategorias();
    } else {
        popularCamposCategoria();
    }
    
    // Limpar formul√°rio
    document.getElementById('produto-id').value = '';
    document.getElementById('produto-nome').value = '';
    document.getElementById('produto-preco').value = '';
    document.getElementById('produto-quantidade').value = '0';
    document.getElementById('produto-categoria').value = '';
    document.getElementById('produto-tempo-preparo').value = '15';
    document.getElementById('produto-descricao').value = '';
    document.getElementById('produto-ativo').checked = true;
    document.getElementById('produto-imagem').value = '';
    
    // Resetar preview da imagem
    const preview = document.getElementById('produto-imagem-preview');
    preview.innerHTML = `
        <div class="preview-placeholder">
            <span style="font-size: 3rem;">üì∑</span>
            <p>Clique para adicionar imagem</p>
            <small>JPG, PNG ou GIF (m√°x. 5MB)</small>
        </div>
    `;
    
    if (produtoId) {
        // Modo edi√ß√£o
        titulo.textContent = '‚úèÔ∏è Editar Produto';
        btnSalvar.textContent = 'üíæ Salvar Altera√ß√µes';
        carregarDadosProduto(produtoId);
    } else {
        // Modo cria√ß√£o
        titulo.textContent = '‚ûï Novo Produto';
        btnSalvar.textContent = 'üíæ Criar Produto';
    }
    
    modal.style.display = 'block';
}

function fecharModalProduto() {
    const modal = document.getElementById('modal-produto');
    modal.style.display = 'none';
}

async function carregarDadosProduto(produtoId) {
    try {
        const response = await fetch(`/caixa/produto/${produtoId}/`);
        const data = await response.json();
        
        if (data.success) {
            const produto = data.produto;
            document.getElementById('produto-id').value = produto.id;
            document.getElementById('produto-nome').value = produto.nome;
            document.getElementById('produto-preco').value = produto.preco;
            document.getElementById('produto-quantidade').value = produto.quantidade_estoque || 0;
            document.getElementById('produto-categoria').value = produto.categoria || '';
            document.getElementById('produto-tempo-preparo').value = produto.tempo_preparo;
            document.getElementById('produto-descricao').value = produto.descricao || '';
            document.getElementById('produto-ativo').checked = produto.ativo;
            
            // Mostrar imagem se existir
            if (produto.imagem) {
                const preview = document.getElementById('produto-imagem-preview');
                preview.innerHTML = `<img src="${produto.imagem}" alt="${produto.nome}">`;
            }
        } else {
            showToast('‚ùå Erro ao carregar produto: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao carregar produto! Verifique sua conex√£o.', 'error');
    }
}

function previewImagemProduto(event) {
    const file = event.target.files[0];
    if (file) {
        // Validar tamanho (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showToast('‚ùå Imagem muito grande! Tamanho m√°ximo: 5MB', 'error');
            event.target.value = '';
            return;
        }
        
        // Validar tipo
        if (!file.type.startsWith('image/')) {
            showToast('‚ùå Arquivo inv√°lido! Selecione uma imagem.', 'error');
            event.target.value = '';
            return;
        }
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('produto-imagem-preview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
    }
}

async function salvarProduto() {
    // Valida√ß√µes
    const nome = document.getElementById('produto-nome').value.trim();
    const preco = document.getElementById('produto-preco').value;
    const categoria = document.getElementById('produto-categoria').value;
    
    if (!nome) {
        showToast('‚ö†Ô∏è Por favor, preencha o nome do produto!', 'info');
        document.getElementById('produto-nome').focus();
        return;
    }
    
    if (!preco || parseFloat(preco) <= 0) {
        showToast('‚ö†Ô∏è Por favor, informe um pre√ßo v√°lido!', 'info');
        document.getElementById('produto-preco').focus();
        return;
    }
    
    if (!categoria) {
        showToast('‚ö†Ô∏è Por favor, selecione uma categoria para o produto!', 'info');
        document.getElementById('produto-categoria').focus();
        return;
    }
    
    // Preparar dados
    const formData = new FormData();
    const produtoId = document.getElementById('produto-id').value;
    
    formData.append('nome', nome);
    formData.append('preco', preco);
    formData.append('quantidade_estoque', document.getElementById('produto-quantidade').value);
    formData.append('categoria', categoria);
    formData.append('tempo_preparo', document.getElementById('produto-tempo-preparo').value);
    formData.append('descricao', document.getElementById('produto-descricao').value);
    formData.append('ativo', document.getElementById('produto-ativo').checked);
    
    // Adicionar imagem se foi selecionada
    const imagemInput = document.getElementById('produto-imagem');
    if (imagemInput.files.length > 0) {
        formData.append('imagem', imagemInput.files[0]);
    }
    
    if (produtoId) {
        formData.append('produto_id', produtoId);
    }
    
    try {
        const url = produtoId ? '/caixa/editar-produto-item/' : '/caixa/criar-produto-item/';
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(produtoId ? '‚úÖ Produto atualizado com sucesso!' : '‚úÖ Produto criado com sucesso!');
            fecharModalProduto();
            location.reload();
        } else {
            showToast('‚ùå Erro ao salvar produto: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao salvar produto! Verifique sua conex√£o.', 'error');
    }
}

// ========== FUN√á√ïES DO MODAL DE COMBO ==========

let comboSlots = [];
let produtosDisponiveis = [];
let comboAtualProdutoId = null;
let emojiPickerAbertoSlot = null;

// Lista de emojis dispon√≠veis para slots
const emojisDisponiveis = ['üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•û', 'üßá', 'üßÄ', 'üçó', 'ü•©', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü´î', 'ü•ô', 'üßÜ', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'üç§', 'üç®', 'üç¶', 'üßÅ', 'üç∞', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'ü•ó', 'ü•ò', 'ü´ï', '‚òï', 'üçµ', 'ü´ñ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üçπ'];

function toggleEmojiPickerSlot(slotIndex, event) {
    event.stopPropagation();
    
    // Fechar picker anterior se houver
    const pickerAnterior = document.querySelector('.emoji-picker-slot');
    if (pickerAnterior) {
        pickerAnterior.remove();
    }
    
    // Se estava aberto para este slot, apenas fechar
    if (emojiPickerAbertoSlot === slotIndex) {
        emojiPickerAbertoSlot = null;
        return;
    }
    
    // Criar novo picker
    const input = event.target;
    const container = input.parentElement;
    
    const picker = document.createElement('div');
    picker.className = 'emoji-picker-slot';
    picker.innerHTML = emojisDisponiveis.map(emoji => 
        `<button type="button" onclick="event.stopPropagation(); selecionarEmojiSlot(${slotIndex}, '${emoji}')">${emoji}</button>`
    ).join('');
    
    container.appendChild(picker);
    emojiPickerAbertoSlot = slotIndex;
    
    // Prevenir que o picker feche ao clicar dentro dele
    picker.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // Fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', fecharEmojiPickerSlot, { once: true });
    }, 100);
}

function selecionarEmojiSlot(slotIndex, emoji) {
    comboSlots[slotIndex].emoji = emoji;
    renderizarSlotsCombo();
    fecharEmojiPickerSlot();
}

function fecharEmojiPickerSlot() {
    const picker = document.querySelector('.emoji-picker-slot');
    if (picker) {
        picker.remove();
    }
    emojiPickerAbertoSlot = null;
}

async function abrirModalCombo(produtoId = null) {
    const modal = document.getElementById('modal-combo');
    const titulo = document.getElementById('modal-combo-titulo');
    
    // Resetar estado
    comboSlots = [];
    comboAtualProdutoId = produtoId;
    
    // Carregar produtos dispon√≠veis
    await carregarProdutosParaCombo();
    
    if (produtoId) {
        // Modo edi√ß√£o - carregar combo existente
        titulo.textContent = '‚úèÔ∏è Editar Combo';
        await carregarDadosCombo(produtoId);
    } else {
        // Modo cria√ß√£o - criar novo produto combo
        titulo.textContent = 'üéÅ Novo Combo';
        document.getElementById('combo-nome').value = '';
        document.getElementById('combo-preco').value = '';
        document.getElementById('combo-produto-id').value = '';
        renderizarSlotsCombo();
    }
    
    modal.style.display = 'block';
}

function fecharModalCombo() {
    const modal = document.getElementById('modal-combo');
    modal.style.display = 'none';
    comboSlots = [];
    comboAtualProdutoId = null;
}

async function carregarProdutosParaCombo() {
    try {
        const response = await fetch('/caixa/combo/produtos/');
        const data = await response.json();
        
        if (data.success) {
            produtosDisponiveis = data.produtos;
        }
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

async function carregarDadosCombo(produtoId) {
    try {
        const response = await fetch(`/caixa/combo/configurar/${produtoId}/`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('combo-produto-id').value = data.produto_id;
            document.getElementById('combo-nome').value = data.produto_nome;
            
            // Carregar dados do produto
            const produtoResponse = await fetch(`/caixa/produto/${produtoId}/`);
            const produtoData = await produtoResponse.json();
            if (produtoData.success) {
                document.getElementById('combo-preco').value = produtoData.produto.preco;
            }
            
            // Carregar slots
            comboSlots = data.slots;
            renderizarSlotsCombo();
        }
    } catch (error) {
        console.error('Erro ao carregar combo:', error);
        showToast('Erro ao carregar dados do combo', 'error');
    }
}

function adicionarSlotCombo() {
    const novoSlot = {
        id: null,
        nome: '',
        emoji: 'üìã',
        ordem: comboSlots.length,
        itens: []
    };
    
    comboSlots.push(novoSlot);
    renderizarSlotsCombo();
}

function removerSlotCombo(index) {
    if (confirm('Tem certeza que deseja remover este slot?')) {
        comboSlots.splice(index, 1);
        // Reordenar
        comboSlots.forEach((slot, i) => {
            slot.ordem = i;
        });
        renderizarSlotsCombo();
    }
}

function adicionarItemSlot(slotIndex) {
    // Abrir modal de sele√ß√£o de produto
    slotIndexAtual = slotIndex;
    abrirModalSelecionarProdutoSlot();
}

let slotIndexAtual = null;

function abrirModalSelecionarProdutoSlot() {
    const modal = document.getElementById('modal-selecionar-produto-slot');
    renderizarProdutosSlot();
    modal.style.display = 'block';
}

function fecharModalSelecionarProdutoSlot() {
    const modal = document.getElementById('modal-selecionar-produto-slot');
    modal.style.display = 'none';
    slotIndexAtual = null;
    document.getElementById('busca-produto-slot').value = '';
}

function renderizarProdutosSlot() {
    const lista = document.getElementById('lista-produtos-slot');
    const busca = document.getElementById('busca-produto-slot').value.toLowerCase();
    
    const produtosFiltrados = produtosDisponiveis.filter(p => 
        p.nome.toLowerCase().includes(busca) || 
        p.id.toString().includes(busca)
    );
    
    if (produtosFiltrados.length === 0) {
        lista.innerHTML = '<div class="empty-slots-message"><p>Nenhum produto encontrado</p></div>';
        return;
    }
    
    lista.innerHTML = produtosFiltrados.map(produto => {
        const statusTexto = produto.ativo ? '' : ' (Inativo)';
        const statusClasse = produto.ativo ? '' : 'sem-estoque';
        
        return `
            <div class="selecao-opcao-card ${statusClasse}" onclick="selecionarProdutoParaSlot(${produto.id}, '${produto.nome.replace(/'/g, "\\'")}', ${produto.quantidade_estoque})" style="cursor: pointer;">
                <div class="selecao-opcao-nome">${produto.nome}${statusTexto}</div>
                <div class="selecao-opcao-estoque">Estoque: ${produto.quantidade_estoque}</div>
            </div>
        `;
    }).join('');
}

function filtrarProdutosSlot() {
    renderizarProdutosSlot();
}

function selecionarProdutoParaSlot(produtoId, produtoNome, estoque) {
    const slot = comboSlots[slotIndexAtual];
    
    // Adicionar item ao slot
    slot.itens.push({
        id: null,
        produto_id: produtoId,
        produto_nome: produtoNome,
        quantidade_abate: 1.0,
        estoque_disponivel: estoque
    });
    
    renderizarSlotsCombo();
    fecharModalSelecionarProdutoSlot();
}

function removerItemSlot(slotIndex, itemIndex) {
    if (confirm('Remover este item do slot?')) {
        comboSlots[slotIndex].itens.splice(itemIndex, 1);
        renderizarSlotsCombo();
    }
}

function renderizarSlotsCombo() {
    const lista = document.getElementById('combo-slots-lista');
    
    if (comboSlots.length === 0) {
        lista.innerHTML = `
            <div class="empty-slots-message">
                <p>Nenhum slot adicionado ainda.</p>
                <small>Clique em "+ Adicionar Slot" para come√ßar</small>
            </div>
        `;
        return;
    }
    
    lista.innerHTML = comboSlots.map((slot, slotIndex) => `
        <div class="slot-card">
            <div class="slot-card-header">
                <div style="display: flex; gap: 0.6rem; flex: 1; align-items: center;">
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="üìã" 
                            value="${slot.emoji || 'üìã'}"
                            onchange="comboSlots[${slotIndex}].emoji = this.value"
                            onclick="toggleEmojiPickerSlot(${slotIndex}, event)"
                            style="width: 50px; height: 38px; text-align: center; font-size: 1.3rem; cursor: pointer; padding: 0.4rem;"
                            maxlength="2"
                            title="Clique para escolher emoji"
                            readonly
                        >
                    </div>
                    <input 
                        type="text" 
                        class="form-control" 
                        placeholder="Nome do slot (ex: Escolha seu Lanche)" 
                        value="${slot.nome}"
                        onchange="comboSlots[${slotIndex}].nome = this.value"
                        style="flex: 1; height: 38px;"
                    >
                </div>
                <div class="slot-card-actions">
                    <button class="btn-icon-small" onclick="adicionarItemSlot(${slotIndex})" title="Adicionar item">+</button>
                    <button class="btn-icon-small btn-danger" onclick="removerSlotCombo(${slotIndex})" title="Remover slot">üóëÔ∏è</button>
                </div>
            </div>
            
            <div class="slot-itens-lista">
                ${slot.itens.length === 0 ? 
                    '<p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.8rem 0; text-align: center;">Nenhum item vinculado</p>' :
                    slot.itens.map((item, itemIndex) => `
                        <div class="slot-item">
                            <div class="slot-item-produto">
                                <strong>${item.produto_nome}</strong>
                                <small style="color: var(--text-secondary); display: block;">Estoque: ${item.estoque_disponivel}</small>
                            </div>
                            <div class="slot-item-quantidade">
                                <span style="font-size: 1.1rem; font-weight: 600; color: var(--btn-primary);">1x</span>
                                <small style="color: var(--text-secondary); display: block;">Abate</small>
                            </div>
                            <div class="slot-item-remove">
                                <button class="btn-icon btn-danger" onclick="removerItemSlot(${slotIndex}, ${itemIndex})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        </div>
    `).join('');
}

async function salvarCombo() {
    try {
        const nome = document.getElementById('combo-nome').value.trim();
        const preco = document.getElementById('combo-preco').value.trim();
        const produtoId = document.getElementById('combo-produto-id').value;
        
        // Valida√ß√µes
        if (!nome) {
            showToast('Nome do combo √© obrigat√≥rio', 'error');
            return;
        }
        
        if (!preco || parseFloat(preco) <= 0) {
            showToast('Pre√ßo do combo √© obrigat√≥rio e deve ser maior que zero', 'error');
            return;
        }
        
        if (comboSlots.length === 0) {
            showToast('Adicione pelo menos um slot ao combo', 'error');
            return;
        }
        
        // Validar que todos os slots t√™m nome e itens
        for (let i = 0; i < comboSlots.length; i++) {
            const slot = comboSlots[i];
            if (!slot.nome.trim()) {
                showToast(`Slot ${i + 1} precisa de um nome`, 'error');
                return;
            }
            if (slot.itens.length === 0) {
                showToast(`Slot "${slot.nome}" precisa ter pelo menos um item vinculado`, 'error');
                return;
            }
        }
        
        let finalProdutoId = produtoId;
        
        // Se n√£o tem produto_id, criar novo produto
        if (!finalProdutoId) {
            const formData = new FormData();
            formData.append('nome', nome);
            formData.append('preco', preco);
            formData.append('descricao', 'Combo configur√°vel');
            formData.append('quantidade_estoque', '999');
            formData.append('categoria', 'Combo');
            formData.append('ativo', 'true');
            
            const produtoResponse = await fetch('/caixa/criar-produto-item/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            const produtoData = await produtoResponse.json();
            if (!produtoData.success) {
                showToast('Erro ao criar produto: ' + produtoData.error);
                return;
            }
            
            finalProdutoId = produtoData.produto_id;
        }
        
        // Salvar configura√ß√£o do combo
        const response = await fetch('/caixa/combo/configurar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                produto_id: finalProdutoId,
                slots: comboSlots
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Combo salvo com sucesso!', 'success');
            fecharModalCombo();
            location.reload();
        } else {
            showToast('‚ùå Erro ao salvar combo: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao salvar combo! Verifique sua conex√£o.', 'error');
    }
}

// ========== FUN√á√ïES DO MODAL DE SELE√á√ÉO DE COMBO (PDV) ==========

let comboSelecaoAtual = null;
let escolhasCombo = {};

async function abrirModalSelecaoCombo(comboId, comboNome, comboPreco) {
    const modal = document.getElementById('modal-selecao-combo');
    
    console.log('=== ABRINDO MODAL DE SELE√á√ÉO DE COMBO ===');
    console.log('Combo ID:', comboId);
    console.log('Combo Nome:', comboNome);
    console.log('Combo Pre√ßo:', comboPreco);
    
    // Resetar estado
    escolhasCombo = {};
    comboSelecaoAtual = { id: comboId, nome: comboNome, preco: comboPreco };
    
    // Atualizar informa√ß√µes do combo
    document.getElementById('selecao-combo-id').value = comboId;
    document.getElementById('selecao-combo-nome').textContent = comboNome;
    document.getElementById('selecao-combo-preco').textContent = `R$ ${parseFloat(comboPreco).toFixed(2)}`;
    
    // Carregar op√ß√µes do combo
    try {
        const url = `/caixa/combo/${comboId}/opcoes/`;
        console.log('Buscando op√ß√µes do combo:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('Resposta da API:', data);
        
        if (data.success) {
            console.log('Total de slots:', data.slots.length);
            data.slots.forEach((slot, index) => {
                console.log(`Slot ${index + 1}: ${slot.nome} - ${slot.itens.length} itens`);
                slot.itens.forEach((item, itemIndex) => {
                    console.log(`  Item ${itemIndex + 1}: ${item.nome} - Estoque: ${item.estoque_disponivel}`);
                });
            });
            
            renderizarSlotsSelecao(data.slots);
            modal.style.display = 'block';
        } else {
            console.error('Erro na resposta:', data.error);
            showToast('Erro ao carregar op√ß√µes do combo: ' + data.error);
        }
    } catch (error) {
        console.error('Erro ao carregar combo:', error);
        showToast('Erro ao carregar combo!', 'error');
    }
}

function fecharModalSelecaoCombo() {
    const modal = document.getElementById('modal-selecao-combo');
    modal.style.display = 'none';
    escolhasCombo = {};
    comboSelecaoAtual = null;
}

function renderizarSlotsSelecao(slots) {
    const lista = document.getElementById('selecao-slots-lista');
    
    console.log('=== RENDERIZANDO SLOTS DE SELE√á√ÉO ===');
    console.log('Total de slots recebidos:', slots.length);
    
    if (!slots || slots.length === 0) {
        console.warn('Nenhum slot para renderizar!');
        lista.innerHTML = '<div class="loading-message">Nenhum slot configurado para este combo</div>';
        return;
    }
    
    lista.innerHTML = slots.map((slot, slotIndex) => {
        console.log(`Renderizando slot ${slotIndex + 1}:`, slot.nome, '- Itens:', slot.itens.length);
        
        // Verificar se o slot tem apenas 1 op√ß√£o
        const temApenasUmaOpcao = slot.itens.length === 1;
        
        if (temApenasUmaOpcao) {
            console.log(`  ‚ö†Ô∏è Slot "${slot.nome}" tem apenas 1 item:`, slot.itens[0].nome);
        }
        
        return `
        <div class="selecao-slot-card">
            <div class="selecao-slot-header">${slot.nome}</div>
            <div class="selecao-slot-opcoes">
                ${slot.itens.map((item, itemIndex) => {
                    console.log(`    Renderizando item ${itemIndex + 1}:`, item.nome, '- Ativo:', item.produto_ativo);
                    
                    // Produto inativo ou sem estoque n√£o pode ser selecionado
                    const produtoInativo = item.produto_ativo === false;
                    const semEstoque = item.tem_estoque_suficiente === false;
                    const naoSelecionavel = produtoInativo || semEstoque;
                    
                    let classeEstoque = '';
                    let mensagemEstoque = '';
                    
                    if (produtoInativo) {
                        classeEstoque = 'sem-estoque';
                        mensagemEstoque = 'Produto inativo ‚ö†Ô∏è';
                    } else if (semEstoque) {
                        classeEstoque = 'sem-estoque';
                        mensagemEstoque = `Estoque: ${item.estoque_disponivel} ‚ö†Ô∏è`;
                    } else {
                        mensagemEstoque = `Estoque: ${item.estoque_disponivel}`;
                    }
                    
                    const autoSelecionado = (temApenasUmaOpcao && !naoSelecionavel) ? 'selected' : '';
                    
                    return `
                    <div class="selecao-opcao-card ${autoSelecionado} ${classeEstoque}" 
                         data-slot-id="${slot.id}" 
                         data-produto-id="${item.produto_id}"
                         data-quantidade-abate="${item.quantidade_abate}"
                         onclick="selecionarOpcaoCombo(${slot.id}, ${item.produto_id}, '${item.nome}', ${item.quantidade_abate}, ${!naoSelecionavel})">
                        <span class="selecao-opcao-check">‚úì</span>
                        <div class="selecao-opcao-nome">${item.nome}</div>
                        <div class="selecao-opcao-estoque ${naoSelecionavel ? 'estoque-insuficiente' : ''}">
                            ${mensagemEstoque}
                        </div>
                    </div>
                    `;
                }).join('')}
            </div>
        </div>
        `;
    }).join('');
    
    console.log('Slots renderizados com sucesso');
    
    // Selecionar automaticamente slots com apenas 1 op√ß√£o (se estiver ativo e tiver estoque)
    slots.forEach(slot => {
        if (slot.itens.length === 1) {
            const item = slot.itens[0];
            const produtoAtivo = item.produto_ativo !== false;
            const temEstoque = item.tem_estoque_suficiente !== false;
            const podeSelecionar = produtoAtivo && temEstoque;
            
            console.log(`Auto-selecionando slot "${slot.nome}":`, item.nome, '- Ativo:', produtoAtivo, '- Tem estoque:', temEstoque, '- Pode selecionar:', podeSelecionar);
            
            if (podeSelecionar) {
                escolhasCombo[slot.id] = {
                    slot_id: slot.id,
                    produto_id: item.produto_id,
                    produto_nome: item.nome,
                    quantidade_abate: item.quantidade_abate
                };
            }
        }
    });
    
    console.log('Escolhas autom√°ticas registradas:', escolhasCombo);
}

function selecionarOpcaoCombo(slotId, produtoId, produtoNome, quantidadeAbate, podeSelecionar) {
    // Verificar se pode selecionar (produto ativo e com estoque)
    if (!podeSelecionar) {
        showToast('Este item n√£o est√° dispon√≠vel (produto inativo ou sem estoque)!', 'error');
        return;
    }
    
    // Desmarcar outras op√ß√µes do mesmo slot
    const cards = document.querySelectorAll(`.selecao-opcao-card[data-slot-id="${slotId}"]`);
    cards.forEach(card => card.classList.remove('selected'));
    
    // Marcar a op√ß√£o selecionada
    const cardSelecionado = document.querySelector(`.selecao-opcao-card[data-slot-id="${slotId}"][data-produto-id="${produtoId}"]`);
    if (cardSelecionado) {
        cardSelecionado.classList.add('selected');
    }
    
    // Registrar escolha
    escolhasCombo[slotId] = {
        slot_id: slotId,
        produto_id: produtoId,
        produto_nome: produtoNome,
        quantidade_abate: quantidadeAbate
    };
    
    console.log('Op√ß√£o selecionada:', escolhasCombo[slotId]);
}

async function confirmarSelecaoCombo() {
    // Validar que todos os slots foram preenchidos
    const totalSlots = document.querySelectorAll('.selecao-slot-card').length;
    const escolhasFeitas = Object.keys(escolhasCombo).length;
    
    if (escolhasFeitas < totalSlots) {
        showToast(`Por favor, selecione um item para todos os slots (${escolhasFeitas}/${totalSlots})`, 'info');
        return;
    }
    
    // Enviar escolhas para o backend
    try {
        const response = await fetch('/caixa/combo/adicionar-pedido/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                combo_id: comboSelecaoAtual.id,
                escolhas: Object.values(escolhasCombo)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Adicionar combo ao carrinho
            adicionarComboAoCarrinho(result.combo);
            fecharModalSelecaoCombo();
        } else {
            showToast('Erro ao adicionar combo: ' + result.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao adicionar combo ao pedido!', 'error');
    }
}

function adicionarComboAoCarrinho(combo) {
    // Adicionar combo ao array de itens do pedido
    itensPedido.push({
        produto_id: combo.produto_id,  // ID do produto, n√£o do combo
        nome: combo.nome,
        preco: parseFloat(combo.preco),
        quantidade: 1,
        is_combo: true,
        escolhas: combo.escolhas,
        observacoes: ''
    });
    
    atualizarListaItens();
}

// Modificar a fun√ß√£o atualizarListaItens para exibir combos corretamente
const atualizarListaItensOriginal = atualizarListaItens;
atualizarListaItens = function() {
    const listaItens = document.getElementById('lista-itens');
    const totalElement = document.getElementById('total-pedido');
    const itensCount = document.getElementById('itens-count');
    const btnFinalizar = document.querySelector('.btn-finalizar-pedido-full');
    
    if (itensPedido.length === 0) {
        listaItens.innerHTML = `
            <div class="carrinho-vazio">
                <div class="carrinho-vazio-icon">üõí</div>
                <p>Carrinho vazio</p>
                <small>Clique nos itens do card√°pio para adicionar</small>
            </div>
        `;
        totalElement.textContent = '0.00';
        itensCount.textContent = '0';
        btnFinalizar.disabled = true;
        localStorage.removeItem('caixa_carrinho_temp');
        return;
    }
    
    let html = '';
    let total = 0;
    
    itensPedido.forEach((item, index) => {
        const subtotal = item.preco * item.quantidade;
        total += subtotal;
        
        if (item.is_combo) {
            // Renderizar combo com escolhas
            const escolhasHtml = item.escolhas.map(e => 
                `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-left: 1rem;">‚Ä¢ ${e.produto_nome}</div>`
            ).join('');
            
            html += `
                <div class="item-carrinho">
                    <div class="item-info">
                        <div class="item-nome">üéÅ ${item.nome}</div>
                        ${escolhasHtml}
                        <div class="item-detalhes">R$ ${item.preco.toFixed(2)} x ${item.quantidade} = R$ ${subtotal.toFixed(2)}</div>
                    </div>
                    <div class="item-acoes">
                        <button onclick="alterarQuantidade(${index}, -1)" class="btn-qty">-</button>
                        <span class="item-quantidade">${item.quantidade}</span>
                        <button onclick="alterarQuantidade(${index}, 1)" class="btn-qty">+</button>
                        <button onclick="removerProduto(${index})" class="btn-remove">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        } else {
            // Renderizar produto normal
            html += `
                <div class="item-carrinho">
                    <div class="item-info">
                        <div class="item-nome">${item.nome}</div>
                        <div class="item-detalhes">R$ ${item.preco.toFixed(2)} x ${item.quantidade} = R$ ${subtotal.toFixed(2)}</div>
                    </div>
                    <div class="item-acoes">
                        <button onclick="alterarQuantidade(${index}, -1)" class="btn-qty">-</button>
                        <span class="item-quantidade">${item.quantidade}</span>
                        <button onclick="alterarQuantidade(${index}, 1)" class="btn-qty">+</button>
                        <button onclick="removerProduto(${index})" class="btn-remove">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }
    });
    
    listaItens.innerHTML = html;
    totalElement.textContent = total.toFixed(2);
    itensCount.textContent = itensPedido.length;
    btnFinalizar.disabled = false;
    salvarCarrinhoTemporario();
};

// ========== FUN√á√ïES DO MODAL DE EDITAR USU√ÅRIO ==========

async function abrirModalEditarUsuario(usuarioId) {
    const modal = document.getElementById('modal-editar-usuario');
    
    try {
        const response = await fetch(`/auth/usuario/${usuarioId}/`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('usuario-id').value = data.usuario.id;
            document.getElementById('usuario-username').value = data.usuario.username;
            document.getElementById('usuario-email').value = data.usuario.email || '';
            document.getElementById('usuario-tipo').value = data.usuario.tipo;
            document.getElementById('usuario-telefone').value = data.usuario.telefone || '';
            document.getElementById('usuario-ativo').checked = data.usuario.is_active;
            document.getElementById('usuario-senha').value = '';
            
            modal.style.display = 'block';
        } else {
            showToast('Erro ao carregar usu√°rio: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao carregar dados do usu√°rio', 'error');
    }
}

function fecharModalEditarUsuario() {
    const modal = document.getElementById('modal-editar-usuario');
    modal.style.display = 'none';
}

async function salvarUsuario() {
    const usuarioId = document.getElementById('usuario-id').value;
    const username = document.getElementById('usuario-username').value.trim();
    const email = document.getElementById('usuario-email').value.trim();
    const tipo = document.getElementById('usuario-tipo').value;
    const telefone = document.getElementById('usuario-telefone').value.trim();
    const isActive = document.getElementById('usuario-ativo').checked;
    const senha = document.getElementById('usuario-senha').value;
    
    if (!username) {
        showToast('Nome de usu√°rio √© obrigat√≥rio', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/auth/usuario/${usuarioId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                username,
                email,
                tipo,
                telefone,
                is_active: isActive,
                ...(senha && { senha })
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Usu√°rio atualizado com sucesso!', 'success');
            fecharModalEditarUsuario();
            location.reload();
        } else {
            showToast('‚ùå Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao salvar usu√°rio', 'error');
    }
}

// ========== FUN√á√ïES DE RELAT√ìRIOS ==========

let filtroAtual = 'hoje';
let mostrarTop10 = false;
let intervalRelatorios = null;

// Aplicar filtro r√°pido
function aplicarFiltroRapido(filtro) {
    filtroAtual = filtro;
    
    // Atualizar bot√µes ativos
    document.querySelectorAll('.btn-filtro-rapido').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Mostrar/esconder filtros personalizados
    const filtrosPersonalizados = document.getElementById('filtros-personalizados');
    if (filtro === 'personalizado') {
        filtrosPersonalizados.style.display = 'block';
        // Definir datas padr√£o
        const hoje = new Date();
        const umMesAtras = new Date();
        umMesAtras.setMonth(umMesAtras.getMonth() - 1);
        document.getElementById('data-inicio').valueAsDate = umMesAtras;
        document.getElementById('data-fim').valueAsDate = hoje;
    } else {
        filtrosPersonalizados.style.display = 'none';
        carregarRelatorios();
    }
}

// Carregar relat√≥rios
async function carregarRelatorios() {
    console.log('=== INICIANDO CARREGAMENTO DE RELAT√ìRIOS ===');
    console.log('Filtro atual:', filtroAtual);
    
    try {
        let dataInicio, dataFim;
        
        if (filtroAtual === 'personalizado') {
            dataInicio = document.getElementById('data-inicio').value;
            dataFim = document.getElementById('data-fim').value;
            
            if (!dataInicio || !dataFim) {
                showToast('Por favor, selecione as datas de in√≠cio e fim', 'info');
                return;
            }
        }
        
        const params = new URLSearchParams({
            filtro: filtroAtual,
            ...(dataInicio && { data_inicio: dataInicio }),
            ...(dataFim && { data_fim: dataFim })
        });
        
        const url = `/caixa/relatorios/dados/?${params}`;
        console.log('URL da requisi√ß√£o:', url);
        
        const response = await fetch(url);
        console.log('Status da resposta:', response.status);
        
        if (!response.ok) {
            console.error('Erro HTTP:', response.status, response.statusText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Dados recebidos:', data);
        
        if (data.success) {
            console.log('Atualizando cards com:', data.resumo);
            atualizarCards(data.resumo);
            
            console.log('Renderizando top itens:', data.top_itens.length, 'itens');
            renderizarTopItens(data.top_itens);
            
            console.log('Renderizando hist√≥rico:', data.historico.length, 'pedidos');
            renderizarHistorico(data.historico);
        } else {
            console.error('Resposta sem sucesso:', data);
        }
    } catch (error) {
        console.error('ERRO ao carregar relat√≥rios:', error);
        console.error('Stack trace:', error.stack);
    }
}

// Atualizar cards de resumo
function atualizarCards(resumo) {
    console.log('Atualizando cards com resumo:', resumo);
    try {
        document.getElementById('total-vendas').textContent = `R$ ${resumo.total_vendas.toFixed(2)}`;
        document.getElementById('total-pedidos').textContent = resumo.total_pedidos;
        document.getElementById('ticket-medio').textContent = `R$ ${resumo.ticket_medio.toFixed(2)}`;
        document.getElementById('total-itens').textContent = resumo.total_itens;
        console.log('Cards atualizados com sucesso');
    } catch (error) {
        console.error('Erro ao atualizar cards:', error);
    }
}

// Renderizar top itens
function renderizarTopItens(itens) {
    const container = document.getElementById('top-itens-container');
    
    if (!container) {
        console.error('Elemento top-itens-container n√£o encontrado!');
        return;
    }
    
    const limite = mostrarTop10 ? 10 : 5;
    const itensExibir = itens.slice(0, limite);
    
    if (itensExibir.length === 0) {
        container.innerHTML = '<div class="loading-message">Nenhum item vendido no per√≠odo</div>';
        return;
    }
    
    let html = '';
    itensExibir.forEach((item, index) => {
        html += `
            <div class="top-item">
                <div class="top-item-posicao">#${index + 1}</div>
                <div class="top-item-info">
                    <div class="top-item-nome">${item.nome}</div>
                    <div class="top-item-quantidade">${item.quantidade} unidades vendidas</div>
                </div>
                <div class="top-item-valor">R$ ${item.total.toFixed(2)}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Toggle top 5/10
function toggleTopItens() {
    mostrarTop10 = !mostrarTop10;
    const btn = document.getElementById('btn-expandir-top');
    btn.textContent = mostrarTop10 ? 'Ver Top 5' : 'Ver Top 10';
    carregarRelatorios();
}

// Renderizar hist√≥rico
function renderizarHistorico(pedidos) {
    const tbody = document.getElementById('historico-vendas-tbody');
    
    console.log('Renderizando hist√≥rico com', pedidos.length, 'pedidos');
    
    if (!tbody) {
        console.error('Elemento historico-vendas-tbody n√£o encontrado!');
        return;
    }
    
    if (pedidos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Nenhuma venda no per√≠odo selecionado
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    pedidos.forEach(pedido => {
        try {
            const data = new Date(pedido.criado_em);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            html += `
                <tr>
                    <td style="width: 10%;"><strong>#${pedido.numero_pedido}</strong></td>
                    <td style="width: 20%;">${dataFormatada} ${horaFormatada}</td>
                    <td style="width: 20%;">${pedido.cliente_nome || '-'}</td>
                    <td style="width: 15%;">${pedido.tipo_display}</td>
                    <td style="width: 15%;">${pedido.forma_pagamento_display || '-'}</td>
                    <td style="width: 10%;">${pedido.total_itens}</td>
                    <td style="width: 10%;"><strong>R$ ${pedido.total}</strong></td>
                </tr>
            `;
        } catch (error) {
            console.error('Erro ao renderizar pedido:', pedido, error);
        }
    });
    
    tbody.innerHTML = html;
    console.log('Hist√≥rico renderizado com sucesso');
}

// Exportar PDF (placeholder)
function exportarPDF() {
    showToast('Funcionalidade de exporta√ß√£o PDF em desenvolvimento', 'info');
}

// Exportar Excel (placeholder)
function exportarExcel() {
    showToast('Funcionalidade de exporta√ß√£o Excel em desenvolvimento', 'info');
}

// Iniciar atualiza√ß√£o autom√°tica
function iniciarAtualizacaoRelatorios() {
    // Limpar intervalo anterior se existir
    if (intervalRelatorios) {
        clearInterval(intervalRelatorios);
    }
    
    // Carregar imediatamente
    carregarRelatorios();
    
    // Atualizar a cada 5 segundos
    intervalRelatorios = setInterval(() => {
        carregarRelatorios();
    }, 5000);
}

// Parar atualiza√ß√£o autom√°tica
function pararAtualizacaoRelatorios() {
    if (intervalRelatorios) {
        clearInterval(intervalRelatorios);
        intervalRelatorios = null;
    }
}

// Carregar relat√≥rios ao abrir a aba
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM CARREGADO ===');
    const tabRelatorios = document.getElementById('tab-relatorios');
    console.log('Tab relat√≥rios encontrada:', !!tabRelatorios);
    
    if (tabRelatorios) {
        console.log('Tab relat√≥rios tem classe active?', tabRelatorios.classList.contains('active'));
        if (tabRelatorios.classList.contains('active')) {
            console.log('Aba relat√≥rios est√° ativa no carregamento, iniciando atualiza√ß√£o');
            iniciarAtualizacaoRelatorios();
        }
    }
});

// Observar mudan√ßas de aba para iniciar/parar atualiza√ß√£o
const observerRelatorios = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.target.id === 'tab-relatorios') {
            console.log('Mudan√ßa detectada na aba relat√≥rios');
            if (mutation.target.classList.contains('active')) {
                console.log('Aba relat√≥rios ATIVADA - iniciando atualiza√ß√£o');
                iniciarAtualizacaoRelatorios();
            } else {
                console.log('Aba relat√≥rios DESATIVADA - parando atualiza√ß√£o');
                pararAtualizacaoRelatorios();
            }
        }
    });
});

// Observar a aba de relat√≥rios
const tabRelatoriosElement = document.getElementById('tab-relatorios');
if (tabRelatoriosElement) {
    console.log('Iniciando observa√ß√£o da aba relat√≥rios');
    observerRelatorios.observe(tabRelatoriosElement, { attributes: true, attributeFilter: ['class'] });
} else {
    console.error('Elemento tab-relatorios n√£o encontrado para observa√ß√£o!');
}

</script>
{% endblock %}
